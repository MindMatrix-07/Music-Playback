<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Music Playback Tool</title>
    <script>
        // Analytics Tracking
        (function () {
            // 1. track visit
            fetch('/api/analytics/track', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'VISIT' })
            }).catch(() => { });

            // 2. Track Spam Clicks
            let clickCount = 0;
            let lastClickTime = 0;

            document.addEventListener('click', (e) => {
                const now = Date.now();
                if (now - lastClickTime < 300) { // Clicked twice in 300ms
                    clickCount++;
                } else {
                    clickCount = 1; // Reset
                }
                lastClickTime = now;

                if (clickCount === 5) { // 5 rapid clicks = Spam
                    fetch('/api/analytics/track', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            type: 'SPAM',
                            details: {
                                x: e.clientX,
                                y: e.clientY,
                                element: e.target.tagName
                            }
                        })
                    }).catch(() => { });
                    clickCount = 0; // Reset
                }
            }, true);
        })();
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --spotify-green: #1DB954;
            --spotify-green-light: #1ed760;
            --spotify-dark: #191414;
            --spotify-gradient: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);

            --apple-pink: #FC3C44;
            --apple-red: #FA2D55;
            --apple-gradient: linear-gradient(135deg, #FC3C44 0%, #FA2D55 50%, #FB5C74 100%);

            --youtube-red: #FF0000;
            --youtube-dark: #CC0000;
            --youtube-gradient: linear-gradient(135deg, #FF0000 0%, #CC0000 100%);

            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-card-hover: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border-color: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        /* Dual-Color Gradient Background */
        #dynamic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            background: radial-gradient(circle at top left, var(--bg-dominant, #222) 0%, rgba(0, 0, 0, 1) 60%);
            background-size: 100% 100%;
            transition: --bg-dominant 2s ease, background 2s ease;
            opacity: 0;
            pointer-events: none;
            /* Subtle animation */
            animation: gradientBreath 15s ease infinite alternate;
        }

        /* Register custom property for smooth color transitions if supported */
        @property --bg-dominant {
            syntax: '<color>';
            inherits: false;
            initial-value: #222;
        }

        @keyframes gradientBreath {
            0% {
                background-position: 0% 0%;
                transform: scale(1);
            }

            100% {
                background-position: 20% 20%;
                transform: scale(1.05);
            }
        }

        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: float 20s ease-in-out infinite;
            transition: background 0.8s ease, opacity 0.8s ease;
        }

        .bg-blob.spotify {
            background: var(--spotify-gradient);
            width: 400px;
            height: 400px;
            top: -100px;
            left: -100px;
            opacity: 0;
        }

        .bg-blob.apple {
            background: var(--apple-gradient);
            width: 400px;
            height: 400px;
            top: -100px;
            right: -100px;
            opacity: 0;
        }

        .bg-blob.secondary {
            width: 300px;
            height: 300px;
            bottom: -50px;
            right: 20%;
            animation-delay: -10s;
        }

        .bg-blob.youtube {
            background: var(--youtube-gradient);
            width: 400px;
            height: 400px;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            filter: blur(90px);
        }

        body.spotify-active .bg-blob.spotify {
            opacity: 0.3;
        }

        body.apple-active .bg-blob.apple {
            opacity: 0.3;
        }

        body.spotify-active .bg-blob.secondary {
            background: var(--spotify-gradient);
            opacity: 0.2;
        }

        body.youtube-active .bg-blob.youtube {
            opacity: 0.25;
        }

        body.youtube-active .bg-blob.secondary {
            background: var(--youtube-gradient);
            opacity: 0.15;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(30px, -30px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .site-logo {
            height: 48px;
            width: auto;
            mix-blend-mode: screen;
            opacity: 0.9;
            border-radius: 12px;
            /* Slightly rounded as requested */
            /* Protection */
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
            /* Block all interactions including right-click */
        }


        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            /* Remove margin as wrapper handles gap */
            background: linear-gradient(135deg, #fff 0%, #a0a0a0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            padding: 12px 20px;
            background: var(--bg-card);
            border-radius: 50px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--border-color);
            transition: border-color 0.3s ease;
        }

        body.spotify-active .user-profile {
            border-color: var(--spotify-green);
        }

        body.apple-active .user-profile {
            border-color: var(--apple-pink);
        }

        body.youtube-active .user-profile {
            border-color: var(--youtube-red);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--border-color);
            object-fit: cover;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
        }

        body.spotify-active .user-name {
            color: var(--spotify-green);
        }

        body.apple-active .user-name {
            color: var(--apple-pink);
        }

        body.youtube-active .user-name {
            color: var(--youtube-red);
        }

        /* App Wrapper - Contains all content with max-width */
        .app-wrapper {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
        }

        @media (max-width: 768px) {
            .app-wrapper {
                padding: 0 20px;
            }
        }

        @media (max-width: 480px) {
            .app-wrapper {
                padding: 0 15px;
            }
        }

        .logout-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            padding: 5px;
            display: flex;
            align-items: center;
            transition: color 0.2s;
        }

        .logout-btn:hover {
            color: var(--apple-pink);
        }

        /* Login Button */
        .login-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s ease;
            font-family: inherit;
            text-decoration: none;
        }

        .login-btn.spotify {
            background: var(--spotify-gradient);
        }

        .login-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
        }

        .login-btn svg {
            width: 24px;
            height: 24px;
        }

        .login-subtitle {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Platform Toggle */
        .platform-toggle {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .platform-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            background: var(--bg-card);
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .platform-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .platform-btn.spotify::before {
            background: var(--spotify-gradient);
        }

        .platform-btn.apple::before {
            background: var(--apple-gradient);
        }

        .platform-btn.youtube::before {
            background: var(--youtube-gradient);
        }

        .platform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .platform-btn.active {
            border-color: transparent;
        }

        .platform-btn.active::before {
            opacity: 1;
        }

        .platform-btn.spotify.active {
            box-shadow: 0 0 30px rgba(29, 185, 84, 0.4);
        }

        .platform-btn.apple.active {
            box-shadow: 0 0 30px rgba(252, 60, 68, 0.4);
        }

        .platform-btn.youtube.active {
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
        }

        .platform-logo {
            width: 32px;
            height: 32px;
            position: relative;
            z-index: 1;
        }

        .platform-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }

        /* Search Container */
        .search-container {
            position: relative;
            margin-bottom: 40px;
        }

        .search-wrapper {
            position: relative;
            border-radius: 20px;
            padding: 3px;
            background: var(--border-color);
            transition: all 0.4s ease;
        }

        body.spotify-active .search-wrapper {
            background: var(--spotify-gradient);
            box-shadow: 0 0 40px rgba(29, 185, 84, 0.3);
        }

        body.apple-active .search-wrapper {
            background: var(--apple-gradient);
            box-shadow: 0 0 40px rgba(252, 60, 68, 0.3);
        }

        .search-inner {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            border-radius: 17px;
            padding: 8px 20px;
        }

        .search-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .search-inner:focus-within .search-icon {
            opacity: 1;
        }

        body.spotify-active .search-icon {
            color: var(--spotify-green);
        }

        body.apple-active .search-icon {
            color: var(--apple-pink);
        }

        body.youtube-active .search-icon {
            color: var(--youtube-red);
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem;
            color: var(--text-primary);
            padding: 12px 0;
            font-family: inherit;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        body.spotify-active .search-btn {
            background: var(--spotify-gradient);
        }

        body.apple-active .search-btn {
            background: var(--apple-gradient);
        }

        body.youtube-active .search-btn {
            background: var(--youtube-gradient);
        }

        .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .search-btn:active {
            transform: scale(0.98);
        }

        /* Search Results */
        .search-results {
            margin-bottom: 40px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-header::before {
            content: '';
            width: 4px;
            height: 20px;
            border-radius: 2px;
        }

        body.spotify-active .results-header::before {
            background: var(--spotify-green);
        }

        body.apple-active .results-header::before {
            background: var(--apple-pink);
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .track-list::-webkit-scrollbar {
            width: 6px;
        }

        .track-list::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }

        .track-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .track-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s ease;
        }

        .track-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        body.spotify-active .track-item:hover {
            border-color: var(--spotify-green);
        }

        body.apple-active .track-item:hover {
            border-color: var(--apple-pink);
        }

        .track-item.selected {
            border-width: 2px;
        }

        body.spotify-active .track-item.selected {
            border-color: var(--spotify-green);
            background: rgba(29, 185, 84, 0.1);
        }

        body.apple-active .track-item.selected {
            border-color: var(--apple-pink);
            background: rgba(252, 60, 68, 0.1);
        }

        .track-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--border-color);
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-name {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            color: var(--text-secondary);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-duration {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Player Section */
        .player-section {
            margin-top: 30px;
        }

        .player-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-title::before {
            content: '';
            width: 4px;
            height: 24px;
            border-radius: 2px;
        }

        body.spotify-active .player-title::before {
            background: var(--spotify-green);
        }

        body.apple-active .player-title::before {
            background: var(--apple-pink);
        }

        .embed-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .embed-container:hover {
            border-color: #3a3a3a;
        }

        .embed-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        .embed-placeholder-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 15px;
            opacity: 0.3;
        }

        body.spotify-active .embed-placeholder-icon {
            color: var(--spotify-green);
        }

        body.apple-active .embed-placeholder-icon {
            color: var(--apple-pink);
        }

        /* Preview Player (for non-logged-in Spotify users) */
        .preview-player {
            width: 100%;
            display: none;
        }

        .preview-player.active {
            display: block;
        }

        .preview-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .preview-album-art {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .preview-info {
            flex: 1;
        }

        .preview-track-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .preview-artist {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .preview-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .preview-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .preview-play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--spotify-green);
            color: white;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .preview-play-btn:hover {
            transform: scale(1.1);
            background: var(--spotify-green-light);
        }

        .preview-play-btn svg {
            width: 24px;
            height: 24px;
        }

        .preview-progress {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .preview-progress-bar {
            height: 100%;
            background: var(--spotify-green);
            width: 0%;
            transition: width 0.1s linear;
        }

        .preview-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            min-width: 45px;
            text-align: right;
        }

        .preview-login-prompt {
            text-align: center;
            padding: 15px;
            background: rgba(29, 185, 84, 0.1);
            border: 1px solid rgba(29, 185, 84, 0.3);
            border-radius: 12px;
        }

        .preview-login-prompt p {
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .preview-login-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--spotify-gradient);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .preview-login-btn:hover {
            transform: scale(1.05);
        }

        .preview-login-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Embeds */
        .embed-wrapper {
            width: 100%;
            display: none;
        }

        .embed-wrapper.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .spotify-embed,
        .apple-embed {
            width: 100%;
            border-radius: 12px;
        }

        /* Open in App Buttons */
        .open-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
        }

        .open-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: inherit;
        }

        .open-btn svg {
            width: 20px;
            height: 20px;
        }

        .open-btn.spotify:hover {
            border-color: var(--spotify-green);
            background: rgba(29, 185, 84, 0.1);
            color: var(--spotify-green);
        }

        .open-btn.apple:hover {
            border-color: var(--apple-pink);
            background: rgba(252, 60, 68, 0.1);
            color: var(--apple-pink);
        }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 40px;
        }

        .loading.active {
            display: flex;
        }

        .loading-logo {
            width: 80px;
            height: auto;
            animation: pulse-logo 1.5s ease-in-out infinite;
            mix-blend-mode: screen;
            filter: drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
            border-radius: 16px;
            /* Protection */
            user-select: none;
            -webkit-user-drag: none;
            pointer-events: none;
        }

        @keyframes pulse-logo {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0.5;
            }
        }

        /* 
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        } */

        body.spotify-active .spinner {
            border-top-color: var(--spotify-green);
        }

        body.apple-active .spinner {
            border-top-color: var(--apple-pink);
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        body.spotify-active .loading-dot {
            background: var(--spotify-green);
        }

        body.apple-active .loading-dot {
            background: var(--apple-pink);
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Error Message */
        .error-message {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Mobile Styles */









        .copy-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .lyrics-content {
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.8;
            color: var(--text-primary);
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.05rem;
        }

        body.apple-active .meta-link {
            color: var(--apple-pink);
        }

        body.youtube-active .meta-link {
            color: var(--youtube-red);
        }

        /* Lyrics View Styling */


        .lyrics-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.1rem;
            color: var(--text-primary);
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .lyrics-synced-view {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .lyric-line {
            display: flex;
            gap: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .lyric-line:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lyric-time {
            font-family: monospace;
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 50px;
            opacity: 0.6;
        }

        .lyric-text {
            color: var(--text-primary);
            font-size: 1.05rem;
            line-height: 1.4;
        }

        .lyrics-mode-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 10px;
            gap: 4px;
        }

        .mode-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 6px 16px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--spotify-green);
            color: white;
        }

        body.apple-active .mode-btn.active {
            background: var(--apple-gradient);
        }

        body.youtube-active .mode-btn.active {
            background: var(--youtube-gradient);
        }


        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .header {
                margin-bottom: 25px;
            }

            .header-title-wrapper {
                flex-direction: row;
                gap: 10px;
            }

            .site-logo {
                height: 32px;
            }

            .header p {
                font-size: 0.95rem;
            }

            /* Compact Platform Toggle */
            .platform-toggle {
                gap: 10px;
                margin-bottom: 25px;
            }

            .platform-btn {
                padding: 10px 16px;
                border-radius: 12px;
                flex: 1;
                justify-content: center;
            }

            .platform-logo {
                width: 24px;
                height: 24px;
            }

            .platform-name {
                font-size: 0.95rem;
            }

            /* Integrated Search Bar on Mobile */
            .search-container {
                margin-bottom: 25px;
            }

            .search-wrapper {
                border-radius: 50px;
                padding: 3px;
                /* slight border effect */
            }

            .search-inner {
                padding: 4px;
                padding-left: 15px;
                border-radius: 48px;
                display: flex;
                align-items: center;
                flex-wrap: nowrap;
                gap: 8px;
                position: relative;
            }

            .search-icon {
                width: 20px;
                height: 20px;
                margin-right: 5px;
            }

            .search-input {
                flex: 1;
                font-size: 0.95rem;
                padding: 10px 0;
                min-width: 0;
                /* allows text truncation if needed */
            }

            .search-btn {
                padding: 8px 18px;
                font-size: 0.85rem;
                border-radius: 50px;
                flex-shrink: 0;
                margin: 0;
                font-weight: 700;
                /* Ensure it stands out as a button */
                background: var(--spotify-green);
                color: white;
            }

            /* Adjust button color dynamically via existing body classes if needed, 
               but default inline style uses var(--spotify-active) etc. */
            body.apple-active .search-btn {
                background: var(--apple-gradient);
            }

            body.youtube-active .search-btn {
                background: var(--youtube-gradient);
            }

            /* Compact Track Items */
            .track-list {
                max-height: 50vh;
            }

            .track-item {
                padding: 10px;
                gap: 12px;
            }

            .track-image {
                width: 42px;
                height: 42px;
            }

            .track-info {
                gap: 2px;
            }

            .track-name {
                font-size: 0.95rem;
            }

            .track-artist {
                font-size: 0.85rem;
            }

            /* Player & Embeds */
            .embed-container {
                padding: 15px;
                min-height: 150px;
            }

            .open-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .open-btn {
                width: 100%;
                justify-content: center;
                padding: 10px 20px;
            }

            /* Preview Player */
            .preview-card {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }

            .preview-album-art {
                width: 140px;
                height: 140px;
                margin-bottom: 10px;
            }

            .preview-track-name {
                font-size: 1.2rem;
            }

            /* Metadata Stack */
            .metadata-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .meta-info-col {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .meta-item {
                gap: 4px;
            }

            .meta-links-row {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .meta-media-col {
                order: -1;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            /* Fix Artist Image Visibility */
            .artist-images-area {
                width: 100%;
                max-height: none;
                /* Let it flow */
                overflow: visible;
            }

            .artist-image-container {
                width: 100%;
                /* Fixed width for better visibility control */
                max-width: 250px;
                margin: 0 auto;
                /* Center it */
                display: block;
                /* Ensure block level */
            }

            .artist-card {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .youtube-container iframe {
                height: 200px;
            }
        }

        /* Small Phones */
        @media (max-width: 480px) {
            .meta-info-col {
                grid-template-columns: 1fr;
            }

            .platform-toggle {
                flex-wrap: wrap;
            }

            /* Even tighter search on small screens */
            .search-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .artist-image-container {
                width: 160px;
                /* Smaller image on very small screens */
            }
        }

        /* Hide class */
        .hidden {
            display: none !important;
        }

        /* Metadata Styles */
        .metadata-section {
            padding: 30px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 40px;
        }

        .meta-info-col {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
            align-content: start;
        }

        .meta-media-col {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .artist-images-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
        }

        .artist-images-area.multi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-content: start;
        }

        .artist-images-area::-webkit-scrollbar {
            width: 4px;
        }

        .artist-images-area::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .youtube-container {
            width: 100%;
            max-width: 360px;
            /* Slightly larger than standard 300px album art */
            aspect-ratio: 16 / 9;
            /* Standard YouTube ratio */
            border-radius: 12px;
            overflow: hidden;
            background: black;
            border: 1px solid var(--border-color);
            margin: 0 auto;
            /* Center the player */
        }

        .yt-label {
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .meta-image-col::-webkit-scrollbar {
            width: 4px;
        }

        .meta-image-col::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .artist-card {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .artist-image-container {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            background: var(--bg-dark);
            margin-bottom: 8px;
        }

        /* Check for single image specific styling if needed, but default 100% width works */

        .artist-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* "Fully fit" usually means filling the box elegantly */
            transition: transform 0.5s ease;
        }

        .artist-image:hover {
            transform: scale(1.05);
        }

        .artist-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .meta-links-row {
            grid-column: 1 / -1;
            display: flex;
            gap: 30px;
            margin-top: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .meta-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .meta-value {
            font-size: 1.05rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .meta-link {
            color: var(--spotify-green);
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: opacity 0.2s;
        }

        .meta-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* New Lyrics Module Styling */
        .lyrics-module {
            margin-top: 30px;
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-height: 400px;
            max-height: 600px;
            animation: slideUp 0.6s ease;
        }

        .lyrics-module.hidden {
            display: none !important;
        }

        .lyrics-top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .lyrics-tabs {
            display: flex;
            gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            padding: 4px;
            border-radius: 12px;
        }

        .tab-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tab-btn.active {
            background: var(--spotify-green);
            color: white;
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.3);
        }

        body.apple-active .tab-btn.active {
            background: var(--apple-gradient);
            box-shadow: 0 4px 15px rgba(250, 35, 59, 0.3);
        }

        .lyrics-view-area {
            flex: 1;
            overflow-y: auto;
            padding-right: 10px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.1) transparent;
        }

        .lyrics-view-area::-webkit-scrollbar {
            width: 6px;
        }

        .lyrics-view-area::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .plain-lyrics {
            white-space: pre-wrap;
            line-height: 2;
            font-size: 1.15rem;
            color: var(--text-primary);
            text-align: center;
        }

        .synced-lyrics-container {
            display: flex;
            flex-direction: column;
            gap: 24px;
            padding: 100px 0;
        }

        .synced-line {
            font-size: 1.4rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.2);
            transition: all 0.4s ease;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            text-align: center;
            filter: blur(2px);
            transform: scale(0.95);
        }

        .synced-line.active {
            color: #fff;
            filter: blur(0);
            transform: scale(1.1);
            text-shadow: 0 0 20px rgba(255, 255, 255, 0.3);
        }

        .loading-lyrics {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            gap: 15px;
            color: var(--text-secondary);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Adjustments */









        .copy-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .lyrics-content {
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.8;
            color: var(--text-primary);
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.05rem;
        }

        body.apple-active .meta-link {
            color: var(--apple-pink);
        }

        /* Lyrics View Styling */


        .lyrics-content {
            white-space: pre-wrap;
            line-height: 1.8;
            font-size: 1.1rem;
            color: var(--text-primary);
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .lyrics-synced-view {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .lyric-line {
            display: flex;
            gap: 15px;
            padding: 8px 12px;
            border-radius: 8px;
            transition: background 0.2s;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .lyric-line:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .lyric-time {
            font-family: monospace;
            color: var(--text-secondary);
            font-size: 0.85rem;
            min-width: 50px;
            opacity: 0.6;
        }

        .lyric-text {
            color: var(--text-primary);
            font-size: 1.05rem;
            line-height: 1.4;
        }

        .lyrics-mode-toggle {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            padding: 4px;
            border-radius: 10px;
            gap: 4px;
        }

        .mode-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 6px 16px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .mode-btn.active {
            background: var(--spotify-green);
            color: white;
        }

        body.apple-active .mode-btn.active {
            background: var(--apple-gradient);
        }


        @media (max-width: 768px) {
            .metadata-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .meta-image-col {
                order: -1;
                /* Show image first on mobile */
                max-width: 300px;
                margin: 0 auto;
            }

            .meta-links-row {
                flex-direction: column;
                gap: 20px;
            }
        }

        /* Settings UI */
        .settings-icon-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            z-index: 100;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .settings-icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .settings-icon-btn svg {
            width: 24px;
            height: 24px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease;
        }

        .settings-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            /* Prevent clipping */
            overflow-y: auto;
            /* Allow scrolling */
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease;
        }

        /* Settings Guide */
        .guide-collapsible {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .guide-toggle-btn {
            background: none;
            border: none;
            color: var(--spotify-green);
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.9rem;
            font-weight: 600;
            align-items: center;
            padding: 5px 0;
        }

        .guide-toggle-btn:hover {
            opacity: 0.9;
        }

        .guide-content {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s ease-in-out;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .guide-content.expanded {
            max-height: 1000px;
            opacity: 1;
            margin-top: 15px;
            padding-bottom: 5px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            cursor: pointer;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(-2px);
        }

        .back-btn svg {
            width: 20px;
            height: 20px;
        }

        .steps-list {
            padding-left: 20px;
            line-height: 1.6;
            margin: 0;
        }

        .steps-list li {
            margin-bottom: 8px;
        }

        .steps-list b {
            color: var(--text-primary);
        }

        .guide-note {
            margin-top: 10px;
            font-style: italic;
            opacity: 0.8;
            font-size: 0.8rem;
        }


        .setting-item {
            margin-bottom: 25px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .setting-item input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .setting-item input:focus {
            border-color: var(--spotify-green);
            outline: none;
        }

        .setting-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            line-height: 1.4;
        }

        .settings-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .primary-btn {
            background: var(--spotify-green);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.2s;
        }

        .primary-btn:hover {
            transform: scale(1.05);
        }

        .secondary-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        /* Copyright Protection */
        .protected-img {
            -webkit-user-drag: none;
            user-select: none;
            pointer-events: auto;
            /* Allow clicks but not drags/selects */
        }

        /* Spam Protection Overlay */
        .spam-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            text-align: center;
            display: none;
        }

        .spam-overlay.active {
            display: flex;
        }

        .spam-title {
            color: #ff6b6b;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        /* Access Lock Overlay */
        .lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            /* Higher than spam overlay */
            text-align: center;
        }

        .lock-input {
            background: #333;
            border: 1px solid #444;
            color: #fff;
            padding: 10px 15px;
            font-size: 1.2rem;
            border-radius: 5px;
            margin-bottom: 15px;
            width: 200px;
            text-align: center;
            outline: none;
        }

        .lock-input:focus {
            border-color: #1DB954;
        }

        .hidden {
            display: none !important;
        }

        /* Maintenance Overlay */
        .maint-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 30000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            text-align: center;
            padding: 20px;
        }

        /* Performance Optimizations */
        #dynamic-bg,
        .bg-blob,
        .synced-line,
        .track-item {
            will-change: transform, opacity;
        }

        .synced-line {
            will-change: transform, color, filter;
        }
    </style>
</head>

<body class="spotify-active">
    <div id="dynamic-bg"></div>

    <!-- Maintenance Overlay -->
    <div id="maintOverlay" class="maint-overlay hidden">
        <div style="font-size: 4rem; margin-bottom: 20px;"></div>
        <h1 style="color: #ff5555; margin-bottom: 20px;">System Maintenance</h1>
        <p id="maintReason" style="font-size: 1.2rem; color: #ccc; max-width: 600px; line-height: 1.6;">
            We are currently performing updates. Please check back later.
        </p>
    </div>

    <div id="spamOverlay" class="spam-overlay">
        <div class="spam-title"> Too Many Clicks</div>
        <p style="color: var(--text-secondary);">Please slow down. Access paused for <span id="spamTimer">10</span>s.
        </p>
    </div>
    <script>
        // Spam Click Detection
        (function () {
            let clickCount = 0;
            const LIMIT = 15;
            const TIME_FRAME = 3000; // 3 secs
            const LOCKOUT_TIME = 10000; // 10 secs
            let resetTimer;

            document.addEventListener('click', (e) => {
                // Ignore clicks inside the overlay itself
                if (e.target.closest('#spamOverlay')) return;

                clickCount++;

                if (clickCount >= LIMIT) {
                    lockoutUser();
                }

                // Reset count if no spam detected within timeframe
                clearTimeout(resetTimer);
                resetTimer = setTimeout(() => {
                    clickCount = 0;
                }, TIME_FRAME);
            }, true);

            function lockoutUser() {
                console.warn('Spam clicks detected');
                const overlay = document.getElementById('spamOverlay');
                const timerEl = document.getElementById('spamTimer');
                if (overlay.classList.contains('active')) return;

                overlay.classList.add('active');

                let remaining = LOCKOUT_TIME / 1000;
                timerEl.textContent = remaining;

                const interval = setInterval(() => {
                    remaining--;
                    timerEl.textContent = remaining;
                    if (remaining <= 0) {
                        clearInterval(interval);
                        overlay.classList.remove('active');
                        clickCount = 0;
                    }
                }, 1000);
            }
        })();
    </script>
    <!-- Animated Background -->
    <div class="background-animation">
        <div class="bg-blob spotify"></div>
        <div class="bg-blob apple"></div>
        <div class="bg-blob youtube"></div>
        <div class="bg-blob secondary"></div>
    </div>

    <div class="container" id="appContent" style="display: none;">
        <div class="app-wrapper"> <!-- App wrapper for max-width constraint -->
            <!-- Settings Button -->
            <button id="settingsBtn" class="settings-icon-btn" title="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path
                        d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-.5 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-.5 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-.5 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73L12.22 2z">
                    </path>
                    <circle cx="12" cy="12" r="3"></circle>
                </svg>
            </button>

            <!-- Header -->
            <header class="header">
                <div class="header-title-wrapper">

                    <h1>Music Playback</h1>
                </div>
                <p>Search and play music from your favorite platform</p>
            </header>

            <!-- User Profile (shown when logged in with Spotify) -->
            <div class="user-profile hidden" id="userProfile">
                <img class="user-avatar" id="userAvatar" src="" alt="Profile">
                <span class="user-name" id="userName">User</span>
                <button class="logout-btn" onclick="logout()" title="Logout">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>

            <!-- Login Section (only shown for Spotify when not logged in) -->
            <div class="login-section hidden" id="loginSection">
                <a href="/api/spotify-login" class="login-btn spotify">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                    </svg>
                    Login with Spotify
                </a>
                <p class="login-subtitle">Login to play full tracks</p>
            </div>

            <!-- Platform Toggle -->
            <div class="platform-toggle">
                <button class="platform-btn spotify active" onclick="selectPlatform('spotify')">
                    <svg class="platform-logo" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                    </svg>
                    <span class="platform-name">Spotify</span>
                </button>
                <button class="platform-btn apple" onclick="selectPlatform('apple')">
                    <svg class="platform-logo" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.106 1.596-.35 2.295-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.042-1.8-.335-2.22-1.09-.46-.827-.19-1.94.69-2.53.38-.254.82-.385 1.264-.497.378-.095.762-.163 1.14-.254.33-.08.53-.29.617-.613.03-.11.04-.225.04-.34-.002-1.633 0-3.265 0-4.898v-.163c-.035.018-.058.027-.078.04l-5.317 1.396v.124c0 2.57 0 5.14-.002 7.71 0 .403-.047.8-.204 1.175-.264.63-.72 1.054-1.378 1.266-.35.113-.72.18-1.09.21-.87.067-1.65-.17-2.2-.86-.67-.84-.52-2.19.32-2.9.394-.327.856-.5 1.34-.613.478-.11.96-.195 1.44-.3.328-.072.538-.27.64-.59.04-.12.06-.25.06-.38V7.47c0-.16.03-.31.1-.46.1-.2.26-.33.47-.39.16-.04.32-.07.48-.1 1.9-.39 3.8-.79 5.69-1.18.21-.05.42-.08.63-.08.38.01.65.25.72.64.02.1.03.2.03.31v3.9z" />
                    </svg>
                    <span class="platform-name">Apple Music</span>
                </button>
                <button class="platform-btn youtube" onclick="selectPlatform('youtube')">
                    <svg class="platform-logo" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                    </svg>
                    <span class="platform-name">YouTube</span>
                </button>
            </div>

            <!-- Search Bar -->
            <div class="search-container">
                <div class="search-wrapper">
                    <div class="search-inner">
                        <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" class="search-input" id="searchInput"
                            placeholder="Search Spotify for songs, artists, albums..."
                            onkeypress="handleKeyPress(event)">
                        <button class="search-btn" onclick="searchMusic()">Search</button>
                    </div>
                </div>
            </div>

            <!-- Search Results -->
            <div class="search-results hidden" id="searchResults">
                <h3 class="results-header">Search Results</h3>
                <div class="track-list" id="trackList"></div>
            </div>

            <!-- Player Section -->
            <section class="player-section">
                <h2 class="player-title">Now Playing</h2>
                <div class="embed-container" id="embedContainer">
                    <!-- Placeholder -->
                    <div class="embed-placeholder" id="placeholder">
                        <svg class="embed-placeholder-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                        </svg>
                        <p>Search for music to start playing</p>
                    </div>

                    <!-- Loading -->
                    <div class="loading" id="loading">

                        <p class="loading-text">Finding your music...</p>
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>

                    <!-- Error -->
                    <div class="error-message" id="errorMessage"></div>

                    <!-- Preview Player (for non-logged-in Spotify users) -->
                    <div class="preview-player" id="previewPlayer">
                        <div class="preview-card">
                            <img class="preview-album-art protected-img" id="previewAlbumArt" src="" alt="Album Art"
                                draggable="false" oncontextmenu="return false;">
                            <div class="preview-info">
                                <div class="preview-track-name" id="previewTrackName">Track Name</div>
                                <div class="preview-artist" id="previewArtist">Artist</div>
                                <span class="preview-badge">30s Preview</span>
                            </div>
                        </div>
                        <div class="preview-controls">
                            <button class="preview-play-btn" id="previewPlayBtn" onclick="togglePreview()">
                                <svg id="previewPlayIcon" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M8 5v14l11-7z" />
                                </svg>
                            </button>
                            <div class="preview-progress" id="previewProgress" onclick="seekPreview(event)">
                                <div class="preview-progress-bar" id="previewProgressBar"></div>
                            </div>
                            <span class="preview-time" id="previewTime">0:00 / 0:30</span>
                        </div>
                        <div class="preview-login-prompt">
                            <p>Login with your Spotify account to play full tracks</p>
                            <a href="/api/spotify-login" class="preview-login-btn">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                                </svg>
                                Login with Spotify
                            </a>
                        </div>
                        <div class="open-buttons">
                            <a href="#" class="open-btn spotify" id="previewOpenBtn" target="_blank">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                                </svg>
                                Open in Spotify
                            </a>
                        </div>
                    </div>

                    <!-- Spotify Embed Wrapper (for logged-in users) -->
                    <div class="embed-wrapper" id="spotifyWrapper">
                        <iframe id="spotifyEmbed" class="spotify-embed" style="border-radius:12px" src="" width="100%"
                            height="152" frameBorder="0" allowfullscreen=""
                            allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                            loading="lazy">
                        </iframe>
                        <div class="open-buttons">
                            <a href="#" class="open-btn spotify" id="openSpotifyBtn" target="_blank">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                                </svg>
                                Open in Spotify
                            </a>
                        </div>
                    </div>

                    <!-- Apple Music Embed Wrapper -->
                    <div class="embed-wrapper" id="appleWrapper">
                        <iframe id="appleEmbed" class="apple-embed" src="" width="100%" height="175" frameBorder="0"
                            allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
                            style="border-radius: 12px; overflow: hidden; background: transparent;"
                            sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation">
                        </iframe>
                        <div class="open-buttons">
                            <a href="#" class="open-btn apple" id="openAppleBtn" target="_blank">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.106 1.596-.35 2.295-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.042-1.8-.335-2.22-1.09-.46-.827-.19-1.94.69-2.53.38-.254.82-.385 1.264-.497.378-.095.762-.163 1.14-.254.33-.08.53-.29.617-.613.03-.11.04-.225.04-.34-.002-1.633 0-3.265 0-4.898v-.163c-.035.018-.058.027-.078.04l-5.317 1.396v.124c0 2.57 0 5.14-.002 7.71 0 .403-.047.8-.204 1.175-.264.63-.72 1.054-1.378 1.266-.35.113-.72.18-1.09.21-.87.067-1.65-.17-2.2-.86-.67-.84-.52-2.19.32-2.9.394-.327.856-.5 1.34-.613.478-.11.96-.195 1.44-.3.328-.072.538-.27.64-.59.04-.12.06-.25.06-.38V7.47c0-.16.03-.31.1-.46.1-.2.26-.33.47-.39.16-.04.32-.07.48-.1 1.9-.39 3.8-.79 5.69-1.18.21-.05.42-.08.63-.08.38.01.65.25.72.64.02.1.03.2.03.31v3.9z" />
                                </svg>
                                Open in Apple Music
                            </a>
                        </div>
                    </div>

                    <!-- YouTube Embed Wrapper -->
                    <div class="embed-wrapper" id="youtubeWrapper">
                        <iframe id="youtubeEmbed" class="youtube-embed" src="" width="100%" height="200" frameBorder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen style="border-radius: 12px; overflow: hidden; background: #000;">
                        </iframe>
                        <div class="open-buttons">
                            <a href="#" class="open-btn youtube" id="openYoutubeBtn" target="_blank">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z" />
                                </svg>
                                Open in YouTube
                            </a>
                        </div>
                    </div>
                </div>
        </div>
        </section>

        <!-- Metadata Section -->
        <section class="metadata-section hidden" id="metadataSection">
            <h2 class="player-title">Metadata</h2>
            <div class="metadata-grid">
                <!-- Left Column: Info -->
                <div class="meta-info-col">
                    <div class="meta-item">
                        <span class="meta-label">Track Title</span>
                        <span class="meta-value" id="metaTitle">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Artist</span>
                        <span class="meta-value" id="metaArtist">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Album</span>
                        <span class="meta-value" id="metaAlbum">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Duration</span>
                        <span class="meta-value" id="metaDuration">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Release Date</span>
                        <span class="meta-value" id="metaReleased">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Genre</span>
                        <span class="meta-value" id="metaGenre">Loading...</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Language</span>
                        <a href="#" target="_blank" class="meta-link" id="metaLanguage">-</a>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Label</span>
                        <span class="meta-value" id="metaLabel">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ISRC</span>
                        <span class="meta-value" id="metaISRC">-</span>
                    </div>

                    <!-- Links Row -->
                    <div class="meta-links-row">
                        <a href="#" target="_blank" class="meta-link" id="metaSpotifyLink">View on Spotify</a>
                        <a href="#" target="_blank" class="meta-link" id="metaAppleLink">View on Apple Music</a>
                        <a href="#" target="_blank" class="meta-link" id="metaMusixmatch">View Lyrics</a>
                        <a href="#" class="meta-link" id="refLyricsBtn" style="color: #fb923c;">Reference Lyrics</a>
                    </div>
                </div>

                <!-- Right Column: Media (Artists + YouTube) -->
                <div class="meta-media-col">
                    <!-- Artist Images -->
                    <div id="artistImagesContainer" class="artist-images-area">
                        <div class="artist-image-container">
                            <img id="metaArtistImage" class="artist-image protected-img" src="" alt="Artist"
                                onerror="this.style.display='none'" draggable="false" oncontextmenu="return false;">
                        </div>
                        <div class="artist-label">Artist</div>
                    </div>

                    <!-- YouTube Embed -->
                    <div class="youtube-container" id="youtubeContainer">
                        <div class="yt-label">Official Video</div>
                        <iframe id="youtubeEmbed" width="100%" height="150" src="" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
            </div>
        </section>

        <section id="lyricsModule" class="lyrics-module hidden">
            <div class="lyrics-top-bar">
                <div class="lyrics-tabs">
                    <button class="tab-btn active" id="tabPlain" onclick="switchLyricsTab('plain')">Plain</button>
                    <button class="tab-btn" id="tabSynced" onclick="switchLyricsTab('synced')">Synced</button>
                </div>
                <button class="copy-btn" id="copyLyricsBtn" onclick="copyCurrentLyrics()">Copy Lyrics</button>
            </div>

            <div id="syncStatusBanner"
                style="padding: 10px; text-align: center; background: rgba(255, 255, 255, 0.05); color: var(--text-secondary); font-size: 0.85rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.5s ease;">
                Tap a line below  when you hear the vocals to sync lyrics
            </div>
            <div id="lyricsViewArea" class="lyrics-view-area">
            </div>
        </section>
        <!-- Footer -->
        <footer
            style="margin-top: 60px; padding-bottom: 20px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 20px;">
            <a href="privacy.html"
                style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; display: inline-block;">Privacy
                Policy</a>
            <p style="color: var(--text-secondary); font-size: 0.75rem; opacity: 0.5;">&copy; 2026 Music Playback. All
                rights reserved.</p>
            <p
                style="color: var(--text-secondary); font-size: 0.7rem; opacity: 0.4; max-width: 600px; margin: 5px auto 0;">
                This website is an independent project and is not affiliated, associated, authorized, endorsed by, or in
                any way officially connected with Spotify, Apple Music, YouTube, or any of their subsidiaries or
                affiliates.</p>
        </footer>
    </div> <!-- Close app-wrapper -->
    </div> <!-- Close appContent -->

    <!-- Hidden Audio Element for Preview -->
    <audio id="previewAudio" preload="none"></audio>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="settings-card">
            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                <button id="backFromSettingsBtn" class="back-btn" title="Go Back">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M15 18l-6-6 6-6" />
                    </svg>
                </button>
                <h3 style="font-size: 1.25rem; margin: 0; font-weight: 700;">Settings</h3>
            </div>
            <div style="height: 1px; background: var(--border-color); margin: 0 0 20px;"></div>

            <div class="setting-item">
                <label for="ytApiKeyInput">YouTube Data API Key</label>
                <input type="password" id="ytApiKeyInput" placeholder="Paste your API Key here">
            </div>

            <div class="setting-item">
                <label for="googleApiKeyInput">Google Search API Key (Optional)</label>
                <input type="password" id="googleApiKeyInput" placeholder="For Custom Search (if different)">
            </div>

            <div class="setting-item">
                <label for="ytCxInput">Search Engine ID (CX)</label>
                <input type="text" id="ytCxInput" placeholder="Paste your CX ID here">
                <p class="setting-hint" style="margin-top: 5px;">Required for Official Audio search.</p>
            </div>

            <div class="setting-item">
                <p class="setting-hint">
                    Required to play official music videos.
                    <br>
                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
                        style="color:var(--spotify-green); text-decoration: none; display: inline-block; margin-top: 5px;">Get
                        a Key &#8599;</a>
                </p>
                <p style="font-size:0.75rem; color:var(--text-secondary); margin-top:8px; opacity: 0.7;">
                     Key is stored <b>locally</b> on your device and never sent to our server.
                </p>
            </div>

            <div class="setting-item">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <label style="margin-bottom: 0;">Background Animations</label>
                    <div class="toggle-switch-container">
                        <input type="checkbox" id="bg-anim-toggle" onchange="toggleBgAnim()">
                    </div>
                </div>
                <p class="setting-hint">Smoothly blurred album art that moves gently in the background.</p>
            </div>

            <!-- Help Section -->
            <div class="setting-item"
                style="margin-top: 10px; border-top: 1px solid var(--border-color); padding-top: 15px;">
                <button id="toggleMasterGuideBtn" class="guide-toggle-btn" style="font-size: 1rem;">
                    <span> Help & Guides</span>
                    <span id="masterGuideArrow" style="transition: transform 0.3s;"></span>
                </button>

                <div id="masterGuideContent" class="guide-content" style="padding-left: 10px;">
                    <!-- YouTube Guide -->
                    <div class="guide-collapsible" style="margin-top: 10px;">
                        <button id="toggleGuideBtn" class="guide-toggle-btn"
                            style="color: var(--text-secondary); font-size: 0.85rem;">
                            <span>How to get a YouTube API Key</span>
                            <span id="guideArrow" style="transition: transform 0.3s;"></span>
                        </button>
                        <div id="guideContent" class="guide-content">
                            <ol class="steps-list">
                                <li>Go to <a href="https://console.cloud.google.com/" target="_blank"
                                        style="color:var(--spotify-green)">Google Cloud Console</a>.</li>
                                <li>Create a new <b>Project</b>.</li>
                                <li>Enable <b>"YouTube Data API v3"</b>.</li>
                                <li>Create an <b>API Key</b>.</li>
                            </ol>
                        </div>
                    </div>

                    <!-- Google Search Guide -->
                    <div class="guide-collapsible" style="margin-top: 5px;">
                        <button id="toggleGoogleGuideBtn" class="guide-toggle-btn"
                            style="color: var(--text-secondary); font-size: 0.85rem;">
                            <span>How to get a Google Search API Key</span>
                            <span id="googleGuideArrow" style="transition: transform 0.3s;"></span>
                        </button>
                        <div id="googleGuideContent" class="guide-content">
                            <ol class="steps-list">
                                <li>In Google Cloud, enable <b>"Custom Search API"</b>.</li>
                                <li>You can reuse your YouTube Key!</li>
                            </ol>
                        </div>
                    </div>

                    <!-- CX Guide -->
                    <div class="guide-collapsible" style="margin-top: 5px;">
                        <button id="toggleCxGuideBtn" class="guide-toggle-btn"
                            style="color: var(--text-secondary); font-size: 0.85rem;">
                            <span>How to get a CX ID</span>
                            <span id="cxGuideArrow" style="transition: transform 0.3s;"></span>
                        </button>
                        <div id="cxGuideContent" class="guide-content">
                            <ol class="steps-list">
                                <li>Go to <a href="https://programmablesearchengine.google.com/controlpanel/all"
                                        target="_blank" style="color:var(--spotify-green)">Programmable Search
                                        Engine</a>.</li>
                                <li>Add <b>youtube.com</b> to "Sites to search".</li>
                                <li>Copy the <b>Search engine ID</b> (CX).</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions Row -->
            <div class="settings-actions" style="margin-top: 30px; margin-bottom: 20px; display: flex; gap: 10px;">
                <button id="deleteKeyBtn" class="secondary-btn"
                    style="margin-right: auto; color: #ff6b6b; border-color: rgba(255, 107, 107, 0.3);">Delete
                    Key</button>
                <button id="closeSettingsBtn" class="secondary-btn">Go Back</button>
                <button id="saveSettingsBtn" class="primary-btn">Save Changes</button>
            </div>

            <!-- Account Management (Danger Zone) -->
            <div class="setting-item"
                style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-bottom: 0;">
                <label style="color: var(--text-secondary); font-size: 0.85rem;">Account</label>
                <button id="deleteAccountBtn" class="secondary-btn"
                    style="width: 100%; font-size: 0.85rem; padding: 8px; color: #ff6b6b; border-color: rgba(255, 107, 107, 0.3);">
                     Delete Account Data
                </button>
            </div>

            <!-- Diagnostics Section (Footer) -->
            <div class="setting-item"
                style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-bottom: 0;">
                <label style="color: var(--text-secondary); font-size: 0.85rem;">Troubleshooting</label>
                <button id="internalCopyLogBtn" class="secondary-btn"
                    style="width: 100%; font-size: 0.85rem; padding: 8px;">
                     Copy Diagnostic Info
                </button>
                <p id="internalClipConfirm"
                    style="color: var(--spotify-green); font-size: 0.8rem; height: 1.2em; opacity: 0; text-align: center; margin-top: 5px; transition: opacity 0.3s;">
                    Copied to clipboard!</p>
            </div>
        </div>
    </div>

    <script>
        // ... (Existing variables) ...

        // --- DELETE ACCOUNT LOGIC ---
        document.getElementById('deleteAccountBtn').addEventListener('click', async () => {
            if (!confirm(' Are you sure?\n\nThis will permanently delete your Discord binding from our database.\nYou will be logged out immediately.')) return;

            try {
                const res = await fetch('/api/auth/user', { method: 'DELETE' });
                if (res.ok) {
                    alert('Account data deleted successfully.');
                    logout(); // reuse existing logout function
                } else {
                    const data = await res.json();
                    alert('Failed: ' + (data.error || 'Server Error'));
                }
            } catch (e) {
                console.error(e);
                alert('Network Error');
            }
        });
        let currentPlatform = 'spotify';
        let selectedTrack = null;
        let spotifyUser = null;
        let previewAudio = null;

        // DOM Cache for performance
        const ui = {
            searchInput: null,
            trackList: null,
            lyricsModule: null,
            lyricsViewArea: null,
            syncStatusBanner: null,
            loading: null,
            placeholder: null,
            errorMessage: null,
            metadataSection: null,
            init() {
                this.searchInput = document.getElementById('searchInput');
                this.trackList = document.getElementById('trackList');
                this.lyricsModule = document.getElementById('lyricsModule');
                this.lyricsViewArea = document.getElementById('lyricsViewArea');
                this.syncStatusBanner = document.getElementById('syncStatusBanner');
                this.loading = document.getElementById('loading');
                this.placeholder = document.getElementById('placeholder');
                this.errorMessage = document.getElementById('errorMessage');
                this.metadataSection = document.getElementById('metadataSection');
            }
        };

        let isPlaying = false;

        // Check for OAuth callback tokens in URL hash
        function checkAuthCallback() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const userName = params.get('user_name');
                const userImage = params.get('user_image');

                if (accessToken) {
                    spotifyUser = {
                        accessToken,
                        refreshToken: params.get('refresh_token'),
                        expiresIn: params.get('expires_in'),
                        name: userName || 'User',
                        image: userImage || ''
                    };

                    localStorage.setItem('spotify_user', JSON.stringify(spotifyUser));
                    history.replaceState(null, '', window.location.pathname);
                    updateUI();
                }
            }
        }

        function checkStoredUser() {
            const stored = localStorage.getItem('spotify_user');
            if (stored) {
                spotifyUser = JSON.parse(stored);
                updateUI();
            }
        }

        function updateUI() {
            const loginSection = document.getElementById('loginSection');
            const userProfile = document.getElementById('userProfile');

            // Only show login/profile for Spotify
            if (currentPlatform === 'spotify') {
                if (spotifyUser) {
                    loginSection.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    document.getElementById('userName').textContent = spotifyUser.name;
                    document.getElementById('userAvatar').src = spotifyUser.image ||
                        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6 0-8 3-8 6v2h16v-2c0-3-2-6-8-6z"/></svg>';
                } else {
                    loginSection.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                }
                loginSection.classList.add('hidden');
                userProfile.classList.add('hidden');
            } else if (currentPlatform === 'youtube') {
                loginSection.classList.add('hidden');
                userProfile.classList.add('hidden');
            }
        }

        function logout() {
            spotifyUser = null;
            localStorage.removeItem('spotify_user');
            updateUI();
            // Reset player if showing Spotify content
            if (currentPlatform === 'spotify') {
                hideAllEmbeds();
                showPlaceholder('Search for music on Spotify');
            }
        }

        function selectPlatform(platform) {
            currentPlatform = platform;
            selectedTrack = null;

            // Stop any playing preview
            stopPreview();

            // Allow time for fade out effect before stopping playback
            if (platform === 'spotify') {
                // Switching TO Spotify -> Stop Apple Music
                const appleEmbed = document.getElementById('appleEmbed');
                const youtubeEmbed = document.getElementById('youtubeEmbed');
                if (appleEmbed) appleEmbed.src = '';
                if (youtubeEmbed) youtubeEmbed.src = '';
            } else if (platform === 'apple') {
                // Switching TO Apple Music -> Stop Spotify/YouTube
                const spotifyEmbed = document.getElementById('spotifyEmbed');
                const youtubeEmbed = document.getElementById('youtubeEmbed');
                if (spotifyEmbed) spotifyEmbed.src = '';
                if (youtubeEmbed) youtubeEmbed.src = '';
            } else {
                // Switching TO YouTube -> Stop others
                const spotifyEmbed = document.getElementById('spotifyEmbed');
                const appleEmbed = document.getElementById('appleEmbed');
                if (spotifyEmbed) spotifyEmbed.src = '';
                if (appleEmbed) appleEmbed.src = '';
            }

            document.body.classList.remove('spotify-active', 'apple-active', 'youtube-active');
            document.body.classList.add(`${platform}-active`);

            document.querySelectorAll('.platform-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.platform-btn.${platform}`).classList.add('active');

            const placeholders = {
                spotify: 'Search Spotify for songs, artists, albums...',
                apple: 'Search Apple Music for songs, artists, albums...',
                youtube: 'Search YouTube for music videos...'
            }
            document.getElementById('searchInput').placeholder = placeholders[platform];

            // Update login section visibility
            updateUI();

            hideSearchResults();
            hideAllEmbeds();
            const emptyMsgs = {
                spotify: 'Search for music on Spotify',
                apple: 'Search for music on Apple Music',
                youtube: 'Search for music on YouTube'
            }
            showPlaceholder(emptyMsgs[platform]);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') searchMusic();
        }

        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function hideAllEmbeds() {
            document.getElementById('spotifyWrapper').classList.remove('active');
            document.getElementById('appleWrapper').classList.remove('active');
            document.getElementById('youtubeWrapper').classList.remove('active');
            document.getElementById('previewPlayer').classList.remove('active');
            ui.loading?.classList.remove('active');
            document.getElementById('errorMessage').classList.remove('active');
            stopPreview();
        }

        function hideSearchResults() {
            document.getElementById('searchResults').classList.add('hidden');
        }

        function showSearchResults() {
            document.getElementById('searchResults').classList.remove('hidden');
        }

        function showPlaceholder(message) {
            const placeholder = document.getElementById('placeholder');
            placeholder.querySelector('p').textContent = message;
            placeholder.style.display = 'block';
        }

        function hidePlaceholder() {
            document.getElementById('placeholder').style.display = 'none';
        }

        function showError(message) {
            hideAllEmbeds();
            hidePlaceholder();
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        // Preview Player Functions
        function initPreviewAudio() {
            if (window.previewAudioInitialized) return;
            window.previewAudioInitialized = true;

            previewAudio = document.getElementById('previewAudio');
            previewAudio.addEventListener('timeupdate', () => {
                updatePreviewProgress();
                updateSyncedLyrics(previewAudio.currentTime);
            });
            previewAudio.addEventListener('ended', () => {
                isPlaying = false;
                updatePlayButton();
            });
            // Reset lyrics scroll on new play
            previewAudio.addEventListener('play', () => {
                // Optional: Snap to current time immediately
                updateSyncedLyrics(previewAudio.currentTime);
            });
        }

        function togglePreview() {
            if (!previewAudio || !previewAudio.src) return;

            if (isPlaying) {
                previewAudio.pause();
            } else {
                previewAudio.play();
            }
            isPlaying = !isPlaying;
            updatePlayButton();
        }

        function stopPreview() {
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                isPlaying = false;
                updatePlayButton();
            }
        }

        function updatePlayButton() {
            const icon = document.getElementById('previewPlayIcon');
            if (isPlaying) {
                icon.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
            } else {
                icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            }
        }

        function updatePreviewProgress() {
            if (!previewAudio) return;
            const progress = (previewAudio.currentTime / previewAudio.duration) * 100;
            document.getElementById('previewProgressBar').style.width = progress + '%';

            const current = Math.floor(previewAudio.currentTime);
            const total = Math.floor(previewAudio.duration) || 30;
            document.getElementById('previewTime').textContent =
                `0:${current.toString().padStart(2, '0')} / 0:${total.toString().padStart(2, '0')}`;
        }

        function seekPreview(event) {
            if (!previewAudio || !previewAudio.duration) return;
            const rect = event.target.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            previewAudio.currentTime = percent * previewAudio.duration;
        }

        async function searchMusic() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            hideAllEmbeds();
            hidePlaceholder();
            ui.loading?.classList.add('active');
            hideSearchResults();

            try {
                const apiEndpoint = `/api/search?platform=${currentPlatform}&q=${encodeURIComponent(query)}&limit=8`;

                // Add Headers for YouTube
                const headers = {};
                if (currentPlatform === 'youtube') {
                    const apiKey = localStorage.getItem('yt_api_key');
                    const googleKey = localStorage.getItem('google_search_key');
                    const cxId = localStorage.getItem('yt_cx_id');
                    if (!apiKey) {
                        throw new Error('Please set your YouTube API Key in Settings first.');
                    }
                    headers['x-youtube-key'] = apiKey;
                    if (googleKey) headers['x-google-key'] = googleKey;
                    if (cxId) headers['x-google-cx'] = cxId;
                }

                const response = await fetch(apiEndpoint, { headers });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                document.getElementById('loading').classList.remove('active');

                if (data.tracks && data.tracks.length > 0) {
                    renderTrackList(data.tracks);
                    showPlaceholder('Select a song to play');
                } else {
                    showPlaceholder('No results found. Try a different search.');
                }

            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('loading').classList.remove('active');
                showError(`Search failed: ${error.message}`);
            }
        }

        // Security: Prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderTrackList(tracks) {
            if (!ui.trackList) ui.init();
            ui.trackList.innerHTML = '';

            const fragment = document.createDocumentFragment();

            tracks.forEach(track => {
                const trackEl = document.createElement('div');
                trackEl.className = 'track-item';
                trackEl.dataset.trackId = track.id;
                trackEl.innerHTML = `
                    <img class="track-image protected-img" src="${track.image || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%232a2a2a%22 width=%22100%22 height=%22100%22/></svg>'}" 
                        alt="${escapeHtml(track.name)}"
                        draggable="false"
                        oncontextmenu="return false;">
                    <div class="track-info">
                        <div class="track-name">${escapeHtml(track.name)}</div>
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                    </div>
                    <div class="track-duration">${formatDuration(track.duration)}</div>
                `;

                trackEl.addEventListener('click', () => selectTrack(track));
                fragment.appendChild(trackEl);
            });

            ui.trackList.appendChild(fragment);
            showSearchResults();
        }

        function selectTrack(track) {
            selectedTrack = track;
            stopPreview();

            document.querySelectorAll('.track-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.track-item[data-track-id="${track.id}"]`)?.classList.add('selected');

            hideSearchResults();
            hidePlaceholder();
            document.getElementById('errorMessage').classList.remove('active');

            if (currentPlatform === 'spotify') {
                // Use Iframe API if available
                if (embedController) {
                    loadAndPlaySpotify(track.id);
                } else {
                    if (typeof debugLog === 'function') debugLog('Controller not ready, queuing track...');
                    else console.log('Controller not ready, queuing track...');
                    pendingSpotifyTrack = track.id;
                    // Fallback to standard embed temporarily so user sees something
                    const spotifyEmbed = document.getElementById('spotifyEmbed');
                    spotifyEmbed.src = `https://open.spotify.com/embed/track/${track.id}?utm_source=generator&theme=0&autoplay=1`;
                }

                document.getElementById('openSpotifyBtn').href = track.spotifyUrl || `https://open.spotify.com/track/${track.id}`;
                document.getElementById('appleWrapper').classList.remove('active');
                document.getElementById('previewPlayer').classList.remove('active');
                document.getElementById('spotifyWrapper').classList.add('active');
            } else if (currentPlatform === 'apple') {
                // Apple Music
                const appleEmbed = document.getElementById('appleEmbed');
                appleEmbed.src = `https://embed.music.apple.com/us/song/${track.id}`;
                document.getElementById('openAppleBtn').href = track.appleUrl || `https://music.apple.com/song/${track.id}`;
                document.getElementById('spotifyWrapper').classList.remove('active');
                document.getElementById('youtubeWrapper').classList.remove('active');
                document.getElementById('previewPlayer').classList.remove('active');
                document.getElementById('appleWrapper').classList.add('active');
            } else {
                // YouTube
                const youtubeEmbed = document.getElementById('youtubeEmbed');
                youtubeEmbed.src = track.embedUrl;
                document.getElementById('openYoutubeBtn').href = track.youtubeUrl;
                document.getElementById('spotifyWrapper').classList.remove('active');
                document.getElementById('appleWrapper').classList.remove('active');
                document.getElementById('previewPlayer').classList.remove('active');
                document.getElementById('youtubeWrapper').classList.add('active');
            }
            // Fetch and show metadata
            fetchMetadata(track);

            // Auto-fetch synced lyrics immediately
            fetchLyrics(track);

            // Update Dynamic Background
            updateBgImage();
        }

        async function fetchMetadata(track) {
            const metaSection = document.getElementById('metadataSection');
            metaSection.classList.remove('hidden');

            // Reset UI with loaders
            const setLoad = (id) => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'Loading...';
            };
            setLoad('metaTitle');
            setLoad('metaArtist');
            setLoad('metaAlbum');
            setLoad('metaReleased');
            setLoad('metaDuration');
            setLoad('metaGenre');
            setLoad('metaLanguage');
            setLoad('metaLabel');
            setLoad('metaISRC');

            const spoLink = document.getElementById('metaSpotifyLink');
            const appLink = document.getElementById('metaAppleLink');
            const lyricLink = document.getElementById('metaMusixmatch');
            const img = document.getElementById('metaArtistImage');

            if (spoLink) spoLink.textContent = 'Loading...';
            if (appLink) appLink.textContent = 'Loading...';
            if (lyricLink) lyricLink.textContent = 'Loading...';

            if (img) {
                img.src = '';
                img.style.display = 'none';
            }

            // Set immediate values if available from the track object
            if (track.name) document.getElementById('metaTitle').textContent = track.name;
            if (track.artist) document.getElementById('metaArtist').textContent = track.artist;
            if (track.album) document.getElementById('metaAlbum').textContent = track.album;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`/api/get-metadata?id=${track.id}&platform=${currentPlatform}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch metadata');
                }

                // Populate Fields
                document.getElementById('metaTitle').textContent = data.title || track.name || 'N/A';
                document.getElementById('metaArtist').textContent = data.artist || track.artist || 'N/A';
                document.getElementById('metaAlbum').textContent = data.album || 'N/A';

                let dateStr = data.releaseDate || 'N/A';
                if (data.year && data.releaseDate && !data.releaseDate.includes(data.year)) {
                    dateStr += ` (${data.year})`;
                }
                document.getElementById('metaReleased').textContent = dateStr;

                document.getElementById('metaDuration').textContent = data.duration ? formatDuration(data.duration) : 'N/A';
                // Genre
                if (data.genre && data.genre.length > 0) {
                    document.getElementById('metaGenre').textContent = data.genre.slice(0, 3).map(g =>
                        g.charAt(0).toUpperCase() + g.slice(1)
                    ).join(', ');
                } else {
                    document.getElementById('metaGenre').textContent = 'N/A';
                }

                const langEl = document.getElementById('metaLanguage');
                langEl.textContent = 'Click here'; // Keep text static as requested previously

                // Use only primary artist to keep query short
                const mainArtist = track.artist ? track.artist.split(',')[0].trim() : '';
                const langQuery = `${track.name} ${mainArtist} which language?`;

                langEl.href = `https://www.google.com/search?q=${encodeURIComponent(langQuery)}`;
                document.getElementById('metaLabel').textContent = data.recordLabel || 'N/A';
                document.getElementById('metaISRC').textContent = data.isrc || 'N/A';

                // Artist Images (Wikidata Multi-Artist)
                const artistContainer = document.getElementById('artistImagesContainer');
                if (artistContainer) {
                    artistContainer.innerHTML = ''; // Clear previous

                    if (data.artistImages && data.artistImages.length > 0) {
                        // Toggle Grid vs Single layout
                        if (data.artistImages.length > 1) {
                            artistContainer.classList.add('multi-grid');
                        } else {
                            artistContainer.classList.remove('multi-grid');
                        }

                        data.artistImages.forEach(artist => {
                            const card = document.createElement('div');
                            card.className = 'artist-card';
                            card.innerHTML = `
                                <div class="artist-image-container">
                                    <img class="artist-image protected-img" src="${artist.url}" 
                                        alt="${escapeHtml(artist.name)}" 
                                        onerror="this.src='data:image/svg+xml;base64,...'"
                                        draggable="false"
                                        oncontextmenu="return false;">
                                </div>
                                <div class="artist-label">${escapeHtml(artist.name)}</div>
                            `;
                            artistContainer.appendChild(card);
                        });
                    } else {
                        artistContainer.classList.remove('multi-grid');
                        // Fallback placeholder
                        artistContainer.innerHTML = `
                             <div class="artist-image-container"></div>
                             <div class="artist-label">No Image</div>
                         `;
                    }
                }

                // YouTube Embed (BYOK)
                const ytContainer = document.getElementById('youtubeContainer');

                if (ytContainer) {
                    ytContainer.classList.remove('hidden');

                    // Client-side search (requires User Key)
                    const query = `${track.name} ${track.artist} official video`;
                    const ytResult = await searchYouTubeClient(query);

                    if (ytResult.error === 'missing_key') {
                        ytContainer.innerHTML = `
                            <div class="yt-label">Official Video</div>
                            <div style="height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:#000; color:var(--text-secondary); text-align:center; padding:15px;">
                                <span style="font-size:0.85rem;">API Key required for playback</span>
                                <button onclick="document.getElementById('settingsBtn').click()" class="secondary-btn" style="padding:4px 12px; font-size:0.8rem;">Add Key</button>
                            </div>
                        `;
                    } else if (ytResult.error) {
                        let errorMsg = "Connection Error";
                        const lowMsg = (ytResult.message || "").toLowerCase();

                        if (lowMsg.includes('quota')) errorMsg = "Daily Quota Exceeded";
                        else if (lowMsg.includes('not valid')) errorMsg = "Invalid API Key";
                        else if (lowMsg.includes('disabled') || lowMsg.includes('not been used')) errorMsg = "API Not Enabled in Cloud Console";
                        else if (lowMsg.includes('failed to fetch')) errorMsg = "Network Blocked (check VPN/CORS)";
                        else if (ytResult.message) errorMsg = ytResult.message;

                        ytContainer.innerHTML = `
                            <div class="yt-label">Video Error</div>
                            <div style="height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center; background:#010101; color:#ff6b6b; padding:20px; text-align:center; gap:8px; border-radius:8px;">
                                <p style="font-size:0.85rem; font-weight:600; margin:0;">${errorMsg}</p>
                                <button onclick="document.getElementById('settingsBtn').click()" class="secondary-btn" style="padding:4px 10px; font-size:0.75rem; color:#fff; border-color:rgba(255,255,255,0.2);">Check Settings</button>
                            </div>
                        `;
                    } else if (ytResult.id) {
                        ytContainer.innerHTML = `
                            <div class="yt-label">Official Video</div>
                            <iframe id="youtubeEmbed" width="100%" height="150" src="https://www.youtube.com/embed/${ytResult.id}" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                        `;
                    } else {
                        ytContainer.innerHTML = `
                            <div class="yt-label">Official Video</div>
                            <div style="height:150px; display:flex; align-items:center; justify-content:center; background:#000; color:var(--text-secondary);">
                                <p style="font-size:0.9rem;">No video found</p>
                            </div>
                        `;
                    }
                }

                // Links
                if (data.crossLinks.spotify && spoLink) {
                    spoLink.textContent = 'View on Spotify';
                    spoLink.href = data.crossLinks.spotify;
                } else if (spoLink) {
                    spoLink.textContent = 'Not found';
                    spoLink.href = '#';
                }

                if (data.crossLinks.apple && appLink) {
                    appLink.textContent = 'View on Apple Music';
                    appLink.href = data.crossLinks.apple;
                } else if (appLink) {
                    appLink.textContent = 'Not found';
                    appLink.href = '#';
                }

                // Language Link
                if (langEl) {
                    langEl.textContent = 'Click here';
                }

                if (data.musixmatch && lyricLink) {
                    lyricLink.textContent = 'View Lyrics';
                    lyricLink.href = data.musixmatch;
                } else if (lyricLink) {
                    lyricLink.textContent = 'N/A';
                    lyricLink.href = '#';
                }

            } catch (error) {
                console.error('Metadata error:', error);
                const els = ['metaGenre', 'metaReleased', 'metaDuration', 'metaLanguage', 'metaLabel', 'metaISRC'];
                els.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '-';
                });
                if (spoLink) spoLink.textContent = '-';
                if (appLink) appLink.textContent = '-';
                if (lyricLink) lyricLink.textContent = '-';
            }
        }

        // --- NEW LYRICS MODULE (Manual Sync Integrated) ---
        let lyricsData = { plain: '', synced: [], rawSynced: '' };
        let currentLyricsTab = 'plain';

        // Manual Sync (Internal Player) State
        let virtualStartTime = 0;
        let virtualSyncAnchored = false;
        let virtualTimerId = null;

        // Auto-scroll Optimization State
        let lastActiveIndex = -1;
        let autoScrollEnabled = true;
        let scrollTimeout = null;

        async function fetchLyrics(track) {
            console.log("Fetching lyrics with manual sync module for:", track.name);
            const module = document.getElementById("lyricsModule");
            const view = document.getElementById("lyricsViewArea");
            const banner = document.getElementById("syncStatusBanner");

            // Reset Virtual Player
            virtualSyncAnchored = false;
            if (virtualTimerId) clearInterval(virtualTimerId);
            if (banner) {
                banner.textContent = "Tap a line below  when you hear the vocals to sync lyrics";
                banner.style.color = "var(--text-secondary)";
                banner.style.background = "rgba(255, 255, 255, 0.05)";
                banner.style.display = "block";
            }

            if (module) module.classList.remove("hidden");
            if (view) view.innerHTML = '<div class="loading-lyrics"><span>Fetching lyrics...</span></div>';

            lyricsData = { plain: '', synced: [], rawSynced: '' };

            const artist = (track.artists && track.artists[0]?.name) || track.artist || 'Unknown';
            const title = track.name;
            const duration = Math.floor(track.duration_ms / 1000);

            try {
                let url = `https://lrclib.net/api/get?artist_name=${encodeURIComponent(artist)}&track_name=${encodeURIComponent(title)}`;
                if (duration) url += `&duration=${duration}`;

                const res = await fetch(url);
                let data;

                if (res.ok) {
                    data = await res.json();
                } else {
                    const sRes = await fetch(`https://lrclib.net/api/search?q=${encodeURIComponent(title + ' ' + artist)}`);
                    const sData = await sRes.json();
                    if (sData && sData.length > 0) data = sData[0];
                }

                if (data) {
                    lyricsData.plain = data.plainLyrics || 'Only synced lyrics available.';
                    lyricsData.rawSynced = data.syncedLyrics || '';
                    parseSyncedLyrics(data.syncedLyrics);

                    if (lyricsData.synced.length > 0) {
                        switchLyricsTab('synced');
                    } else {
                        switchLyricsTab('plain');
                        const banner = document.getElementById("syncStatusBanner");
                        if (banner) banner.style.display = "none";
                    }
                } else {
                    throw new Error('No lyrics found');
                }
            } catch (e) {
                if (view) view.innerHTML = '<div class="loading-lyrics"><span>No lyrics found for this track.</span></div>';
                const banner = document.getElementById("syncStatusBanner");
                if (banner) banner.style.display = "none";
            }
        }

        function parseSyncedLyrics(lrc) {
            if (!lrc) return;
            const lines = lrc.split('\n');
            const lrcRegex = /^\[(\d{2}):(\d{2})\.(\d{2,3})\](.*)/;

            lines.forEach(line => {
                const match = line.trim().match(lrcRegex);
                if (match) {
                    const time = parseInt(match[1]) * 60 + parseInt(match[2]) + parseInt(match[3]) / 1000;
                    const text = match[4].trim();
                    if (text) lyricsData.synced.push({ time, text });
                }
            });
        }

        function switchLyricsTab(tab) {
            currentLyricsTab = tab;
            const tPlain = document.getElementById("tabPlain");
            const tSynced = document.getElementById("tabSynced");
            const banner = document.getElementById("syncStatusBanner");

            if (tPlain) tPlain.classList.toggle("active", tab === "plain");
            if (tSynced) tSynced.classList.toggle("active", tab === "synced");
            if (banner) {
                if (tab === "synced" && lyricsData.synced.length > 0) {
                    banner.style.display = "block";
                } else {
                    banner.style.display = "none";
                }
            }

            renderLyrics();
        }

        function renderLyrics() {
            const view = document.getElementById('lyricsViewArea');
            if (!view) return;

            if (currentLyricsTab === 'plain') {
                view.innerHTML = `<div class="plain-lyrics">${lyricsData.plain || 'No plain lyrics available.'}</div>`;
            } else {
                if (lyricsData.synced.length === 0) {
                    view.innerHTML = '<div class="loading-lyrics">No synced lyrics available.</div>';
                    return;
                }

                let html = '<div class="synced-lyrics-container">';
                lyricsData.synced.forEach((line, i) => {
                    html += `<div class="synced-line" id="line-${i}" onclick="seekTo(${line.time})">${line.text}</div>`;
                });
                html += '</div>';
                view.innerHTML = html;

                // Ensure player is hooked
                if (previewAudio) {
                    const syncHandler = () => { if (!virtualSyncAnchored) syncLyrics(previewAudio.currentTime); };
                    previewAudio.removeEventListener('timeupdate', syncHandler);
                    previewAudio.addEventListener('timeupdate', syncHandler);
                }

                // Setup manual scroll detection for auto-scroll pause
                const lyricsArea = document.getElementById('lyricsViewArea');
                if (lyricsArea && !lyricsArea.scrollListenerAdded) {
                    lyricsArea.scrollListenerAdded = true;
                    lyricsArea.addEventListener('scroll', () => {
                        // If we are scrolling, and it's not from our auto-scroll logic
                        if (lyricsArea.classList.contains('is-scrolling-auto')) return;

                        // Disable auto-scroll for 2 seconds upon user interaction
                        autoScrollEnabled = false;
                        clearTimeout(scrollTimeout);
                        scrollTimeout = setTimeout(() => {
                            autoScrollEnabled = true;
                            // Immediately snap back once re-enabled
                            if (lastActiveIndex !== -1) {
                                const activeLine = document.getElementById(`line-${lastActiveIndex}`);
                                if (activeLine) {
                                    lyricsArea.classList.add('is-scrolling-auto');
                                    activeLine.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                    setTimeout(() => lyricsArea.classList.remove('is-scrolling-auto'), 1000);
                                }
                            }
                        }, 2000);
                    });
                }
            }
        }

        function seekTo(time) {
            if (previewAudio && previewAudio.src && !previewAudio.paused) {
                previewAudio.currentTime = time;
                return;
            }

            // Manual Sync Mode
            console.log("Anchoring Virtual Player at:", time);
            virtualStartTime = Date.now() - (time * 1000);
            virtualSyncAnchored = true;

            if (virtualTimerId) clearInterval(virtualTimerId);
            virtualTimerId = setInterval(() => {
                const elapsed = (Date.now() - virtualStartTime) / 1000;
                syncLyrics(elapsed);

                if (selectedTrack && elapsed > (selectedTrack.duration_ms / 1000) + 10) {
                    clearInterval(virtualTimerId);
                    virtualSyncAnchored = false;
                }
            }, 200);

            // UI Update: Green Rectangular Box Dialogue
            let banner = document.getElementById("syncStatusBanner");
            if (banner) {
                banner.textContent = "Lyrics synced! Tracking music internally...";
                banner.style.color = "#fff";
                banner.style.background = "#1db954";
                banner.style.padding = "12px";
                banner.style.borderRadius = "8px";
                banner.style.fontWeight = "600";
                banner.style.margin = "10px";
                banner.style.boxShadow = "0 4px 12px rgba(0,0,0,0.3)";
                banner.style.display = "block";

                // Disappear after 3 seconds
                setTimeout(() => {
                    banner.style.opacity = "0";
                    banner.style.transform = "translateY(-10px)";
                    setTimeout(() => {
                        banner.style.display = "none";
                        // Reset styles for next music fetch/instruction
                        banner.style.opacity = "1";
                        banner.style.transform = "translateY(0)";
                    }, 500);
                }, 3000);
            }
        }

        function syncLyrics(currentTime) {
            if (currentLyricsTab !== 'synced' || lyricsData.synced.length === 0) return;

            let activeIndex = -1;
            for (let i = 0; i < lyricsData.synced.length; i++) {
                if (lyricsData.synced[i].time <= currentTime) {
                    activeIndex = i;
                } else {
                    break;
                }
            }

            if (activeIndex !== -1 && activeIndex !== lastActiveIndex) {
                lastActiveIndex = activeIndex;
                const lines = document.querySelectorAll('.synced-line');
                lines.forEach(l => l.classList.remove('active'));

                const activeLine = document.getElementById(`line-${activeIndex}`);
                if (activeLine) {
                    activeLine.classList.add('active');

                    if (autoScrollEnabled) {
                        const viewArea = document.getElementById('lyricsViewArea');
                        if (viewArea) {
                            viewArea.classList.add('is-scrolling-auto');
                            // Use scrollIntoView with block:center but ensure it doesn't affect page scroll
                            // Alternatively, calculate top manually if scrollIntoView still causes jumps
                            activeLine.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
                            // Remove helper class after animation
                            setTimeout(() => viewArea.classList.remove('is-scrolling-auto'), 1000);
                        }
                    }
                }
            }
        }

        async function copyCurrentLyrics() {
            const text = currentLyricsTab === 'plain' ? lyricsData.plain : lyricsData.rawSynced;
            if (!text) return;
            try {
                await navigator.clipboard.writeText(text);
                const btn = document.getElementById('copyLyricsBtn');
                const old = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = old, 2000);
            } catch (e) { }
        }

        // Settings Logic
        function initSettings() {
            const settingsModal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const ytInput = document.getElementById('ytApiKeyInput');
            const googleInput = document.getElementById('googleApiKeyInput'); // NEW
            const cxInput = document.getElementById('ytCxInput');
            const saveBtn = document.getElementById('saveSettingsBtn');
            const closeBtn = document.getElementById('closeSettingsBtn');
            const deleteBtn = document.getElementById('deleteKeyBtn');
            const toggleGuideBtn = document.getElementById('toggleGuideBtn');
            const guideContent = document.getElementById('guideContent');
            const guideArrow = document.getElementById('guideArrow');

            const toggleCxGuideBtn = document.getElementById('toggleCxGuideBtn');
            const cxGuideContent = document.getElementById('cxGuideContent');
            const cxGuideArrow = document.getElementById('cxGuideArrow');

            const toggleGoogleGuideBtn = document.getElementById('toggleGoogleGuideBtn');
            const googleGuideContent = document.getElementById('googleGuideContent');
            const googleGuideArrow = document.getElementById('googleGuideArrow');

            const backBtn = document.getElementById('backFromSettingsBtn');

            if (!settingsBtn || !settingsModal) {
                console.warn('Settings elements not found');
                return;
            }

            const openModal = () => {
                if (ytInput) ytInput.value = localStorage.getItem('yt_api_key') || '';
                if (googleInput) googleInput.value = localStorage.getItem('google_search_key') || '';
                if (cxInput) cxInput.value = localStorage.getItem('yt_cx_id') || '';
                settingsModal.classList.remove('hidden');
            };

            const closeModal = () => settingsModal.classList.add('hidden');

            settingsBtn.addEventListener('click', openModal);
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (backBtn) backBtn.addEventListener('click', closeModal);

            // Close on overlay click
            settingsModal.addEventListener('click', (e) => {
                if (e.target === settingsModal) closeModal();
            });

            // Guide Toggle
            if (toggleGuideBtn && guideContent && guideArrow) {
                toggleGuideBtn.addEventListener('click', () => {
                    guideContent.classList.toggle('active');
                    guideArrow.style.transform = guideContent.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            }

            if (toggleCxGuideBtn && cxGuideContent && cxGuideArrow) {
                toggleCxGuideBtn.addEventListener('click', () => {
                    cxGuideContent.classList.toggle('active');
                    cxGuideArrow.style.transform = cxGuideContent.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            }

            const toggleMasterGuideBtn = document.getElementById('toggleMasterGuideBtn');
            const masterGuideContent = document.getElementById('masterGuideContent');
            const masterGuideArrow = document.getElementById('masterGuideArrow');

            if (toggleMasterGuideBtn && masterGuideContent && masterGuideArrow) {
                toggleMasterGuideBtn.addEventListener('click', () => {
                    masterGuideContent.classList.toggle('active');
                    masterGuideArrow.style.transform = masterGuideContent.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            }

            if (toggleGoogleGuideBtn && googleGuideContent && googleGuideArrow) {
                toggleGoogleGuideBtn.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent closing master
                    googleGuideContent.classList.toggle('active');
                    googleGuideArrow.style.transform = googleGuideContent.classList.contains('active') ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            }

            // Save functionality
            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const key = ytInput ? ytInput.value.trim() : '';
                    const googleKey = googleInput ? googleInput.value.trim() : '';
                    const cx = cxInput ? cxInput.value.trim() : '';

                    if (key) {
                        localStorage.setItem('yt_api_key', key);

                        if (googleKey) localStorage.setItem('google_search_key', googleKey);
                        else localStorage.removeItem('google_search_key');

                        if (cx) localStorage.setItem('yt_cx_id', cx);
                        else localStorage.removeItem('yt_cx_id');

                        settingsModal.classList.add('hidden');
                        if (selectedTrack) fetchMetadata(selectedTrack);
                    } else {
                        alert('YouTube API Key is required at minimum.');
                    }
                });
            }

            // Delete functionality
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to remove all API Keys from this device?')) {
                        localStorage.removeItem('yt_api_key');
                        localStorage.removeItem('google_search_key');
                        localStorage.removeItem('yt_cx_id');
                        if (ytInput) ytInput.value = '';
                        if (googleInput) googleInput.value = '';
                        if (cxInput) cxInput.value = '';
                        alert('Keys removed from local storage.');
                        settingsModal.classList.add('hidden');
                    }
                });
            }

            // Diagnostics Copy
            const internalCopyBtn = document.getElementById('internalCopyLogBtn');
            const internalConfirm = document.getElementById('internalClipConfirm');
            if (internalCopyBtn) {
                internalCopyBtn.addEventListener('click', () => {
                    const diag = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        screen: window.innerWidth + 'x' + window.innerHeight,
                        platform: typeof currentPlatform !== 'undefined' ? currentPlatform : 'unknown',
                        hasDeviceID: !!localStorage.getItem('device_binding_id'),
                        deviceID: localStorage.getItem('device_binding_id'),
                        hasYTKey: !!localStorage.getItem('yt_api_key'),
                        authCookie: document.cookie.includes('auth_token'),
                        referrer: document.referrer
                    };

                    navigator.clipboard.writeText(JSON.stringify(diag, null, 2)).then(() => {
                        if (internalConfirm) {
                            internalConfirm.style.opacity = '1';
                            setTimeout(() => internalConfirm.style.opacity = '0', 2000);
                        }
                    });
                });
            }
        }

        // Official YouTube Search (Client-Side)
        async function searchYouTubeClient(query) {
            const apiKey = localStorage.getItem('yt_api_key');
            const googleSearchKey = localStorage.getItem('google_search_key'); // Get Google Search API Key

            if (!apiKey) return { error: 'missing_key' };

            const headers = { 'Content-Type': 'application/json' };
            if (googleSearchKey) {
                headers['x-google-key'] = googleSearchKey; // Add custom header
            }

            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=1&key=${apiKey}`, { headers });

                if (!res.ok) {
                    const errorData = await res.json().catch(() => ({}));
                    const message = (errorData.error && errorData.error.message) || `HTTP Error ${res.status}`;
                    throw new Error(message);
                }

                const data = await res.json();
                if (data.items && data.items.length > 0) {
                    return { id: data.items[0].id.videoId };
                }
                return { id: null };
            } catch (err) {
                console.error('YouTube API Error:', err);
                return { error: 'api_error', message: err.message || "Unknown error" };
            }
        }

        // Debug Helper
        function debugLog(msg) {
            // Visual log removed
            console.log(msg);
        }

        // Spotify Iframe API
        let embedController = null;
        let pendingSpotifyTrack = null;

        window.onSpotifyIframeApiReady = (IFrameAPI) => {
            debugLog('Spotify API Ready');
            const element = document.getElementById('spotifyEmbed');
            const options = {
                uri: 'spotify:track:4cOdK2wGLETKBW3PvgPWqT', // Placeholder
                width: '100%',
                height: '152',
                theme: '0'
            };
            const callback = (EmbedController) => {
                debugLog('EmbedController Created');
                embedController = EmbedController;

                // Check if a track was waiting for the controller
                if (pendingSpotifyTrack) {
                    debugLog('Found pending track, loading...');
                    loadAndPlaySpotify(pendingSpotifyTrack);
                    pendingSpotifyTrack = null;
                }
            };
            IFrameAPI.createController(element, options, callback);
        };

        function loadAndPlaySpotify(trackId) {
            if (!embedController) {
                debugLog('Error: Controller missing during load attempt');
                return;
            }

            debugLog(`Loading URI: spotify:track:${trackId}`);
            embedController.loadUri(`spotify:track:${trackId}`);
            document.getElementById('spotifyWrapper').classList.add('active');

            // "Trigger autoclick once after 2 seconds" logic
            debugLog('Scheduling play in 2s...');
            setTimeout(() => {
                debugLog('Attempting embedController.play()...');
                embedController.play(); // No promise returned by this API usually, but we capture flow
                // Add a follow-up check
                setTimeout(() => debugLog('Play command sent. If no sound, Browser Policy likely blocked it.'), 500);
            }, 2000);
        }

        // URL Parameters Handler (Auto-Search/Play)
        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const query = params.get('q') || params.get('search');

            if (query) {
                debugLog(`Found query: ${query}`);
                const searchInput = document.getElementById('searchInput');
                searchInput.value = query;

                // Trigger search
                await searchMusic();

                // Auto-select first result if available
                const trackList = document.getElementById('trackList');
                if (trackList && trackList.firstChild) {
                    debugLog('Auto-selecting first result');
                    trackList.firstChild.click();
                } else {
                    debugLog('No results found to select');
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            ui.init();
            initPreviewAudio();

            initSettings();
            checkAuthCallback();
            checkStoredUser();
            selectPlatform('spotify');

            // Check for external search query
            checkUrlParams();
        });
    </script>
    <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>

    <!-- Access Code Overlay -->
    <div id="accessOverlay" class="access-overlay">
        <div class="access-card">
            <!-- Branding Header -->
            <div class="access-header-logo"
                style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 20px;">

                <h1
                    style="font-size: 1.8rem; margin: 0; background: linear-gradient(135deg, #fff 0%, #a0a0a0 100%); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    Music Playback</h1>
            </div>

            <h2 style="font-size: 1.1rem; color: #888; font-weight: 400; margin-bottom: 30px; margin-top: -10px;">
                Private Access</h2>

            <!-- Loading Step -->
            <div id="loadingStep" style="margin-top: 20px;">
                <div
                    style="border: 3px solid rgba(255,255,255,0.1); border-top: 3px solid #1DB954; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto 15px;">
                </div>
                <p style="color: #888; font-size: 0.9rem;">Verifying access...</p>
                <style>
                    @keyframes spin {
                        0% {
                            transform: rotate(0deg);
                        }

                        100% {
                            transform: rotate(360deg);
                        }
                    }
                </style>
            </div>

            <!-- Step 1: Discord Login -->
            <div id="discordLoginStep" class="hidden">
                <p style="color: #ccc; margin-bottom: 20px;">Please login with Discord to continue.</p>
                <a href="/api/auth/discord" class="spotify-auth-btn"
                    style="background: #5865F2; width: 100%; justify-content: center; box-sizing: border-box; text-decoration: none; display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 50px; font-weight: 600; font-size: 1rem;">
                    <svg viewBox="0 0 127.14 96.36" fill="white" style="width: 24px; height: 24px;">
                        <path
                            d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.11,77.11,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.89,105.89,0,0,0,126.6,80.22c1.25-23.6-3.26-47.56-18.9-72.15ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5.18-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z" />
                    </svg>
                    Login with Discord
                </a>

                <p style="font-size: 0.7rem; color: #666; margin-top: 10px; text-align: center;">
                    By signing in you are accepting the <a href="/privacy.html" target="_blank"
                        style="color:#888; text-decoration: underline;">privacy policy and terms</a>.
                </p>

                <div class="mobile-stack" style="margin-top: 25px; border-top: 1px solid #333; padding-top: 20px;">
                    <p style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
                        Or continue without Discord (Device Only)
                    </p>
                    <button id="skipDiscordBtn" class="secondary-btn small"
                        style="background: transparent; border: 1px solid #555; font-size: 0.9rem; width: 100%; margin-top: 10px; color: #ccc; cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; padding: 10px; border-radius: 20px;">
                        Continue without Discord
                    </button>
                    <p class="warning-text"
                        style="font-size: 0.75rem; color: #666; margin-top: 10px; line-height: 1.4;">
                        <span style="color: #ffaa00;">Warning:</span> Access and API Keys entered later will be stored
                        in this browser only.
                        You will lose access if you clear data or uninstall the browser.
                    </p>
                </div>
            </div>

            <!-- ... (Code Entry Step remains same logic, just visually wrapped) ... -->


            <!-- Step 2: Code Entry -->
            <div id="codeEntryStep" class="hidden">
                <div class="user-preview"
                    style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; background: #222; padding: 8px 16px; border-radius: 50px; width: fit-content; margin-inline: auto;">
                    <img id="discordAvatar" src="" alt="" style="width: 24px; height: 24px; border-radius: 50%;">
                    <span id="discordUsername" style="color: #5865F2; font-weight: 600; font-size: 0.9rem;"></span>
                </div>

                <div class="access-input-wrapper" style="flex-direction: column;">
                    <input type="text" id="accessCodeInput" placeholder="Access Code" autocomplete="off"
                        class="access-field"
                        style="text-align: center; letter-spacing: 2px; text-transform: uppercase;">
                </div>

                <button id="accessSubmitBtn" class="full-width-btn">Unlock Access</button>
            </div>

            <div class="error-wrapper" style="margin-top: 15px;">
                <p id="accessError" class="access-error"></p>
                <button id="copyLogBtn" class="secondary-btn small hidden"
                    style="margin-top: 10px; font-size: 0.8rem; padding: 5px 10px;"> Copy Error Log</button>
            </div>

            <p id="clipConfirm"
                style="color: var(--spotify-green); font-size: 0.8rem; height: 1.2em; opacity: 0; transition: opacity 0.3s;">
                Copied to clipboard!</p>
        </div>
    </div>

    <style>
        .access-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .access-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .access-card {
            background: #111;
            border: 1px solid #333;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            /* Mobile Optimization */
            box-sizing: border-box;
        }

        /* Mobile tweaks for Access Card */
        @media (max-width: 480px) {
            .access-card {
                padding: 25px 20px;
                width: 95%;
            }

            .access-header-logo img {
                height: 32px !important;
            }

            .access-header-logo h1 {
                font-size: 1.5rem !important;
            }
        }

        .access-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .access-card h2 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .access-card p {
            color: #888;
            margin-bottom: 30px;
        }

        .access-input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .access-field {
            width: 100%;
            background: #222;
            border: 1px solid #333;
            padding: 12px 15px;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
            /* Fix padding width issue */
        }

        .access-field:focus {
            border-color: var(--spotify-green);
        }

        .full-width-btn {
            background: var(--spotify-green);
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .full-width-btn:hover {
            transform: scale(1.02);
            background: #1ed760;
        }

        .access-error {
            color: #ff4d4d;
            font-size: 0.9rem;
            min-height: 20px;
            margin-top: 15px;
        }

        .spotify-auth-btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .spotify-auth-btn:hover {
            transform: scale(1.05);
            background: #1ed760;
        }

        .spotify-auth-btn svg {
            width: 20px;
            height: 20px;
        }

        .hidden {
            display: none !important;
        }

        .user-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            background: #222;
            padding: 8px 16px;
            border-radius: 50px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .user-preview img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .user-preview span {
            color: #1DB954;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .access-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #accessCodeInput {
            flex: 1;
            background: #222;
            border: 1px solid #333;
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        #accessCodeInput:focus {
            border-color: var(--spotify-green);
        }





        .access-error {
            color: #ff4d4d;
            font-size: 0.9rem;
            min-height: 20px;
        }
    </style>

    <script>
        // Auth Logic
        (async function checkAuth() {
            const overlay = document.getElementById('accessOverlay');
            const discordStep = document.getElementById('discordLoginStep');
            const codeStep = document.getElementById('codeEntryStep');

            const codeInput = document.getElementById('accessCodeInput');
            const btn = document.getElementById('accessSubmitBtn');
            const errorMsg = document.getElementById('accessError');
            const copyBtn = document.getElementById('copyLogBtn');
            const clipConfirm = document.getElementById('clipConfirm');
            const skipBtn = document.getElementById('skipDiscordBtn');

            // 1. Get/Create Persistent Device ID
            let deviceId = localStorage.getItem('device_binding_id');
            if (!deviceId) {
                deviceId = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('device_binding_id', deviceId);
            }

            // Skip handler
            if (skipBtn) {
                skipBtn.addEventListener('click', () => {
                    discordStep.classList.add('hidden');
                    codeStep.classList.remove('hidden');
                    // Hide avatar
                    document.querySelector('.user-preview').style.display = 'none';
                });
            }

            // ... (Error Logging Logic Same as Before) ...
            let lastErrorLog = { timestamp: '', browser: navigator.userAgent, error: '', details: null };
            function showError(msg, details = null) {
                errorMsg.textContent = msg;
                copyBtn.classList.remove('hidden');

                // Sanitize details to REMOVE API Keys
                let safeDetails = details;
                if (details && typeof details === 'object') {
                    safeDetails = JSON.parse(JSON.stringify(details)); // Deep copy
                    // Explicitly remove sensitive keys
                    if (safeDetails.yt_api_key) safeDetails.yt_api_key = '[REDACTED]';
                    if (safeDetails.apiKey) safeDetails.apiKey = '[REDACTED]';
                    if (safeDetails.headers) delete safeDetails.headers; // Remove headers incase of tokens
                }

                lastErrorLog = { timestamp: new Date().toISOString(), error: msg, details: safeDetails };
                console.error('Captured Error:', lastErrorLog);
            }
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(JSON.stringify(lastErrorLog, null, 2));
                clipConfirm.style.opacity = '1';
                setTimeout(() => clipConfirm.style.opacity = '0', 2000);
            });

            // 1. Check Auth Status
            try {
                // Show loader (it should be visible by default in HTML, but ensuring logic flow)
                const loadingStep = document.getElementById('loadingStep');

                const res = await fetch('/api/auth/status?_=' + Date.now());
                const data = await res.json();

                // Hide loader
                if (loadingStep) loadingStep.classList.add('hidden');

                if (data.maintenance) {
                    document.getElementById('maintOverlay').classList.remove('hidden');
                    if (data.reason) document.getElementById('maintReason').textContent = data.reason;
                    return; // Stop everything
                } else {
                    document.getElementById('maintOverlay').classList.add('hidden');
                }

                if (data.authenticated) {
                    // Fully Authorized
                    overlay.classList.add('hidden');
                    document.getElementById('appContent').style.display = 'block';
                    return;
                }

                // Not authorized, but maybe logged in to Discord?
                if (data.discordUser) {
                    // Show Code Entry Step
                    discordStep.classList.add('hidden');
                    codeStep.classList.remove('hidden');

                    discordUsername.textContent = data.discordUser.username;
                    if (data.discordUser.avatar) {
                        discordAvatar.src = `https://cdn.discordapp.com/avatars/${data.discordUser.id}/${data.discordUser.avatar}.png`;
                    } else {
                        // Default avatar
                        discordAvatar.src = 'https://cdn.discordapp.com/embed/avatars/0.png';
                    }
                } else {
                    // Not logged in at all -> Show Discord Login Button (Default)
                    discordStep.classList.remove('hidden');
                    codeStep.classList.add('hidden');
                }

            } catch (e) {
                console.error('Auth Check Failed', e);
                // On error, better to show login than get stuck
                if (document.getElementById('loadingStep')) document.getElementById('loadingStep').classList.add('hidden');
                discordStep.classList.remove('hidden');
            }

            // 2. Login Flow (Code Submission only)
            async function attemptLogin() {
                const code = codeInput.value.trim();
                // Name is now handled by backend (Discord Name or Anonymous)

                if (!code) {
                    errorMsg.textContent = 'Please enter the code.';
                    codeInput.focus();
                    return;
                }

                btn.disabled = true;
                btn.style.opacity = '0.5';
                errorMsg.textContent = 'Linking Account...';
                copyBtn.classList.add('hidden');

                try {
                    const res = await fetch('/api/verify-access', {
                        method: 'POST',
                        credentials: 'include', // Force sending cookies
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: code,
                            name: '', // Empty name will trigger backend fallback
                            deviceId: deviceId // Send logic for fallback
                        })
                    });

                    let data;
                    try {
                        data = await res.json();
                    } catch (jsonErr) {
                        throw new Error('Server returned invalid JSON (Crash/500). Response Status: ' + res.status);
                    }

                    if (res.ok) {
                        // Success -> Fade out overlay
                        overlay.classList.add('hidden');
                        document.getElementById('appContent').style.display = 'block'; // Reveal App
                    } else {
                        // Error
                        showError(data.error || 'Invalid code', data.debug || data);
                        // Keep values so they can fix typose
                    }
                } catch (e) {
                    console.error(e);
                    // Network or JSON error
                    showError('Connection Error: ' + (e.message || 'Unknown'), { stack: e.stack });
                } finally {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            }

            btn.addEventListener('click', attemptLogin);

            // Allow Enter key on input
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') attemptLogin();
            });

            // Focus input specifically when overlay is visible
            if (!overlay.classList.contains('hidden')) {
                codeInput.focus();
            }
        })();
        // --- Dynamic Background ---
        function toggleBgAnim() {
            const enabled = document.getElementById('bg-anim-toggle').checked;
            localStorage.setItem('bg_anim_enabled', enabled);
            updateBgState();
        }

        function updateBgState() {
            const enabled = localStorage.getItem('bg_anim_enabled') === 'true';
            document.getElementById('bg-anim-toggle').checked = enabled;
            const bg = document.getElementById('dynamic-bg');
            if (bg) {
                bg.style.opacity = enabled ? '1' : '0';
                if (!enabled) bg.style.backgroundImage = 'none'; // Clear to save resources
                else updateBgImage(); // Restore if re-enabled
            }
        }

        function getDominantColor(imageUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.src = imageUrl;
                img.onload = () => {
                    try {
                        const canvas = document.createElement('canvas');
                        canvas.width = 1;
                        canvas.height = 1;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 1, 1);
                        const [r, g, b] = ctx.getImageData(0, 0, 1, 1).data;
                        resolve(`rgb(${r}, ${g}, ${b})`);
                    } catch (e) {
                        console.warn('CORS denied for image color extraction', e);
                        resolve('#222');
                    }
                };
                img.onerror = () => resolve('#222');
            });
        }

        async function updateBgImage() {
            const enabled = localStorage.getItem('bg_anim_enabled') === 'true';
            if (!enabled || !selectedTrack) return;

            const bg = document.getElementById('dynamic-bg');
            if (bg && selectedTrack.image) {
                const color = await getDominantColor(selectedTrack.image);
                // Set custom property for smooth transition (supported browsers)
                bg.style.setProperty('--bg-dominant', color);
                // Set explicitly for immediate update/fallback
                bg.style.background = `radial-gradient(circle at top left, ${color} 0%, rgba(0, 0, 0, 1) 60%)`;
            }
        }

        // Initialize
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Default to true if not set
            if (localStorage.getItem('bg_anim_enabled') === null) {
                localStorage.setItem('bg_anim_enabled', 'true');
            }
            // Update toggle state immediately
            document.getElementById('bg-anim-toggle').checked = localStorage.getItem('bg_anim_enabled') === 'true';
            updateBgState();

            // Initialize Features
            initPreviewAudio();

            if (typeof initSettings === 'function') initSettings();
        });

        // Hook into existing track play logic (you'll need to call updateBgImage() where tracks are played)
    </script>

</body>

</html>