<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Music Playback</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --spotify-green: #1DB954;
            --spotify-green-light: #1ed760;
            --spotify-dark: #191414;
            --spotify-gradient: linear-gradient(135deg, #1DB954 0%, #1ed760 100%);

            --apple-pink: #FC3C44;
            --apple-red: #FA2D55;
            --apple-gradient: linear-gradient(135deg, #FC3C44 0%, #FA2D55 50%, #FB5C74 100%);

            --bg-dark: #0a0a0a;
            --bg-card: #141414;
            --bg-card-hover: #1a1a1a;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --border-color: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Animated Background */
        .background-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
        }

        .bg-blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.3;
            animation: float 20s ease-in-out infinite;
            transition: background 0.8s ease, opacity 0.8s ease;
        }

        .bg-blob.spotify {
            background: var(--spotify-gradient);
            width: 400px;
            height: 400px;
            top: -100px;
            left: -100px;
            opacity: 0;
        }

        .bg-blob.apple {
            background: var(--apple-gradient);
            width: 400px;
            height: 400px;
            top: -100px;
            right: -100px;
            opacity: 0;
        }

        .bg-blob.secondary {
            width: 300px;
            height: 300px;
            bottom: -50px;
            right: 20%;
            animation-delay: -10s;
        }

        body.spotify-active .bg-blob.spotify {
            opacity: 0.3;
        }

        body.apple-active .bg-blob.apple {
            opacity: 0.3;
        }

        body.spotify-active .bg-blob.secondary {
            background: var(--spotify-gradient);
            opacity: 0.2;
        }

        body.apple-active .bg-blob.secondary {
            background: var(--apple-gradient);
            opacity: 0.2;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(30px, -30px) scale(1.1);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
        }

        /* Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 60px 20px;
            position: relative;
            z-index: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header-title-wrapper {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .site-logo {
            height: 48px;
            width: auto;
            filter: brightness(0) invert(1);
            /* Force White */
            opacity: 0.9;
        }


        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0;
            /* Remove margin as wrapper handles gap */
            background: linear-gradient(135deg, #fff 0%, #a0a0a0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* User Profile */
        .user-profile {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            padding: 12px 20px;
            background: var(--bg-card);
            border-radius: 50px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
            border: 1px solid var(--spotify-green);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--border-color);
            object-fit: cover;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--spotify-green);
        }

        .logout-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 5px;
            display: flex;
            align-items: center;
            transition: color 0.2s;
        }

        .logout-btn:hover {
            color: var(--apple-pink);
        }

        /* Login Button */
        .login-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 14px 28px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            text-decoration: none;
        }

        .login-btn.spotify {
            background: var(--spotify-gradient);
        }

        .login-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(29, 185, 84, 0.3);
        }

        .login-btn svg {
            width: 24px;
            height: 24px;
        }

        .login-subtitle {
            margin-top: 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Platform Toggle */
        .platform-toggle {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
        }

        .platform-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            border: 2px solid var(--border-color);
            border-radius: 16px;
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .platform-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .platform-btn.spotify::before {
            background: var(--spotify-gradient);
        }

        .platform-btn.apple::before {
            background: var(--apple-gradient);
        }

        .platform-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .platform-btn.active {
            border-color: transparent;
        }

        .platform-btn.active::before {
            opacity: 1;
        }

        .platform-btn.spotify.active {
            box-shadow: 0 0 30px rgba(29, 185, 84, 0.4);
        }

        .platform-btn.apple.active {
            box-shadow: 0 0 30px rgba(252, 60, 68, 0.4);
        }

        .platform-logo {
            width: 32px;
            height: 32px;
            position: relative;
            z-index: 1;
        }

        .platform-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            position: relative;
            z-index: 1;
        }

        /* Search Container */
        .search-container {
            position: relative;
            margin-bottom: 40px;
        }

        .search-wrapper {
            position: relative;
            border-radius: 20px;
            padding: 3px;
            background: var(--border-color);
            transition: all 0.4s ease;
        }

        body.spotify-active .search-wrapper {
            background: var(--spotify-gradient);
            box-shadow: 0 0 40px rgba(29, 185, 84, 0.3);
        }

        body.apple-active .search-wrapper {
            background: var(--apple-gradient);
            box-shadow: 0 0 40px rgba(252, 60, 68, 0.3);
        }

        .search-inner {
            display: flex;
            align-items: center;
            background: var(--bg-card);
            border-radius: 17px;
            padding: 8px 20px;
        }

        .search-icon {
            width: 24px;
            height: 24px;
            margin-right: 15px;
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .search-inner:focus-within .search-icon {
            opacity: 1;
        }

        body.spotify-active .search-icon {
            color: var(--spotify-green);
        }

        body.apple-active .search-icon {
            color: var(--apple-pink);
        }

        .search-input {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1.1rem;
            color: var(--text-primary);
            padding: 12px 0;
            font-family: inherit;
        }

        .search-input::placeholder {
            color: var(--text-secondary);
        }

        .search-btn {
            padding: 12px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        body.spotify-active .search-btn {
            background: var(--spotify-gradient);
        }

        body.apple-active .search-btn {
            background: var(--apple-gradient);
        }

        .search-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .search-btn:active {
            transform: scale(0.98);
        }

        /* Search Results */
        .search-results {
            margin-bottom: 40px;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .results-header {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .results-header::before {
            content: '';
            width: 4px;
            height: 20px;
            border-radius: 2px;
        }

        body.spotify-active .results-header::before {
            background: var(--spotify-green);
        }

        body.apple-active .results-header::before {
            background: var(--apple-pink);
        }

        .track-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .track-list::-webkit-scrollbar {
            width: 6px;
        }

        .track-list::-webkit-scrollbar-track {
            background: var(--bg-card);
            border-radius: 3px;
        }

        .track-list::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .track-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .track-item:hover {
            background: var(--bg-card-hover);
            transform: translateX(5px);
        }

        body.spotify-active .track-item:hover {
            border-color: var(--spotify-green);
        }

        body.apple-active .track-item:hover {
            border-color: var(--apple-pink);
        }

        .track-item.selected {
            border-width: 2px;
        }

        body.spotify-active .track-item.selected {
            border-color: var(--spotify-green);
            background: rgba(29, 185, 84, 0.1);
        }

        body.apple-active .track-item.selected {
            border-color: var(--apple-pink);
            background: rgba(252, 60, 68, 0.1);
        }

        .track-image {
            width: 50px;
            height: 50px;
            border-radius: 8px;
            object-fit: cover;
            background: var(--border-color);
        }

        .track-info {
            flex: 1;
            min-width: 0;
        }

        .track-name {
            font-weight: 600;
            font-size: 1rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-artist {
            color: var(--text-secondary);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-duration {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Player Section */
        .player-section {
            margin-top: 30px;
        }

        .player-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .player-title::before {
            content: '';
            width: 4px;
            height: 24px;
            border-radius: 2px;
        }

        body.spotify-active .player-title::before {
            background: var(--spotify-green);
        }

        body.apple-active .player-title::before {
            background: var(--apple-pink);
        }

        .embed-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .embed-container:hover {
            border-color: #3a3a3a;
        }

        .embed-placeholder {
            text-align: center;
            color: var(--text-secondary);
        }

        .embed-placeholder-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 15px;
            opacity: 0.3;
        }

        body.spotify-active .embed-placeholder-icon {
            color: var(--spotify-green);
        }

        body.apple-active .embed-placeholder-icon {
            color: var(--apple-pink);
        }

        /* Preview Player (for non-logged-in Spotify users) */
        .preview-player {
            width: 100%;
            display: none;
        }

        .preview-player.active {
            display: block;
        }

        .preview-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .preview-album-art {
            width: 120px;
            height: 120px;
            border-radius: 8px;
            object-fit: cover;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .preview-info {
            flex: 1;
        }

        .preview-track-name {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .preview-artist {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .preview-badge {
            display: inline-block;
            padding: 4px 12px;
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .preview-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .preview-play-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: var(--spotify-green);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .preview-play-btn:hover {
            transform: scale(1.1);
            background: var(--spotify-green-light);
        }

        .preview-play-btn svg {
            width: 24px;
            height: 24px;
        }

        .preview-progress {
            flex: 1;
            height: 4px;
            background: var(--border-color);
            border-radius: 2px;
            overflow: hidden;
            cursor: pointer;
        }

        .preview-progress-bar {
            height: 100%;
            background: var(--spotify-green);
            width: 0%;
            transition: width 0.1s linear;
        }

        .preview-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            min-width: 45px;
            text-align: right;
        }

        .preview-login-prompt {
            text-align: center;
            padding: 15px;
            background: rgba(29, 185, 84, 0.1);
            border: 1px solid rgba(29, 185, 84, 0.3);
            border-radius: 12px;
        }

        .preview-login-prompt p {
            margin-bottom: 12px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .preview-login-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--spotify-gradient);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s ease;
        }

        .preview-login-btn:hover {
            transform: scale(1.05);
        }

        .preview-login-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Embeds */
        .embed-wrapper {
            width: 100%;
            display: none;
        }

        .embed-wrapper.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .spotify-embed,
        .apple-embed {
            width: 100%;
            border-radius: 12px;
        }

        /* Open in App Buttons */
        .open-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            width: 100%;
            justify-content: center;
        }

        .open-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            border: 2px solid var(--border-color);
            border-radius: 50px;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-family: inherit;
        }

        .open-btn svg {
            width: 20px;
            height: 20px;
        }

        .open-btn.spotify:hover {
            border-color: var(--spotify-green);
            background: rgba(29, 185, 84, 0.1);
            color: var(--spotify-green);
        }

        .open-btn.apple:hover {
            border-color: var(--apple-pink);
            background: rgba(252, 60, 68, 0.1);
            color: var(--apple-pink);
        }

        /* Loading */
        .loading {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 40px;
        }

        .loading.active {
            display: flex;
        }

        .loading-logo {
            width: 80px;
            height: auto;
            animation: pulse-logo 1.5s ease-in-out infinite;
            filter: brightness(0) invert(1) drop-shadow(0 0 10px rgba(255, 255, 255, 0.2));
        }

        @keyframes pulse-logo {
            0% {
                transform: scale(1);
                opacity: 0.5;
            }

            50% {
                transform: scale(1.1);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0.5;
            }
        }

        /* 
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        } */

        body.spotify-active .spinner {
            border-top-color: var(--spotify-green);
        }

        body.apple-active .spinner {
            border-top-color: var(--apple-pink);
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .loading-dots {
            display: flex;
            gap: 6px;
            margin-top: 10px;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: bounce 1.4s ease-in-out infinite both;
        }

        .loading-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .loading-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        body.spotify-active .loading-dot {
            background: var(--spotify-green);
        }

        body.apple-active .loading-dot {
            background: var(--apple-pink);
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Error Message */
        .error-message {
            text-align: center;
            padding: 20px;
            color: #ff6b6b;
            display: none;
        }

        .error-message.active {
            display: block;
        }

        /* Mobile Styles */
        @media (max-width: 768px) {
            .container {
                padding: 20px 15px;
            }

            .header {
                margin-bottom: 25px;
            }

            .header-title-wrapper {
                flex-direction: row;
                gap: 10px;
            }

            .site-logo {
                height: 32px;
            }

            .header p {
                font-size: 0.95rem;
            }

            /* Compact Platform Toggle */
            .platform-toggle {
                gap: 10px;
                margin-bottom: 25px;
            }

            .platform-btn {
                padding: 10px 16px;
                border-radius: 12px;
                flex: 1;
                justify-content: center;
            }

            .platform-logo {
                width: 24px;
                height: 24px;
            }

            .platform-name {
                font-size: 0.95rem;
            }

            /* Integrated Search Bar on Mobile */
            .search-container {
                margin-bottom: 25px;
            }

            .search-wrapper {
                border-radius: 50px;
                padding: 3px;
                /* slight border effect */
            }

            .search-inner {
                padding: 4px;
                padding-left: 15px;
                border-radius: 48px;
                display: flex;
                align-items: center;
                flex-wrap: nowrap;
                gap: 8px;
                position: relative;
            }

            .search-icon {
                width: 20px;
                height: 20px;
                margin-right: 5px;
            }

            .search-input {
                flex: 1;
                font-size: 0.95rem;
                padding: 10px 0;
                min-width: 0;
                /* allows text truncation if needed */
            }

            .search-btn {
                padding: 8px 18px;
                font-size: 0.85rem;
                border-radius: 50px;
                flex-shrink: 0;
                margin: 0;
                font-weight: 700;
                /* Ensure it stands out as a button */
                background: var(--spotify-green);
                color: white;
            }

            /* Adjust button color dynamically via existing body classes if needed, 
               but default inline style uses var(--spotify-active) etc. */
            body.apple-active .search-btn {
                background: var(--apple-gradient);
            }

            /* Compact Track Items */
            .track-list {
                max-height: 50vh;
            }

            .track-item {
                padding: 10px;
                gap: 12px;
            }

            .track-image {
                width: 42px;
                height: 42px;
            }

            .track-info {
                gap: 2px;
            }

            .track-name {
                font-size: 0.95rem;
            }

            .track-artist {
                font-size: 0.85rem;
            }

            /* Player & Embeds */
            .embed-container {
                padding: 15px;
                min-height: 150px;
            }

            .open-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .open-btn {
                width: 100%;
                justify-content: center;
                padding: 10px 20px;
            }

            /* Preview Player */
            .preview-card {
                flex-direction: column;
                text-align: center;
                padding: 15px;
            }

            .preview-album-art {
                width: 140px;
                height: 140px;
                margin-bottom: 10px;
            }

            .preview-track-name {
                font-size: 1.2rem;
            }

            /* Metadata Stack */
            .metadata-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .meta-info-col {
                grid-template-columns: 1fr 1fr;
                gap: 15px;
            }

            .meta-item {
                gap: 4px;
            }

            .meta-links-row {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }

            .meta-media-col {
                order: -1;
                display: flex;
                flex-direction: column;
                gap: 20px;
            }

            /* Fix Artist Image Visibility */
            .artist-images-area {
                width: 100%;
                max-height: none;
                /* Let it flow */
                overflow: visible;
            }

            .artist-image-container {
                width: 200px;
                /* Fixed width for better visibility control */
                max-width: 100%;
                margin: 0 auto;
                /* Center it */
                display: block;
                /* Ensure block level */
            }

            .artist-card {
                width: 100%;
                display: flex;
                flex-direction: column;
                align-items: center;
            }

            .youtube-container iframe {
                height: 200px;
            }
        }

        /* Small Phones */
        @media (max-width: 480px) {
            .meta-info-col {
                grid-template-columns: 1fr;
            }

            .platform-toggle {
                flex-wrap: wrap;
            }

            /* Even tighter search on small screens */
            .search-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .artist-image-container {
                width: 160px;
                /* Smaller image on very small screens */
            }
        }

        /* Hide class */
        .hidden {
            display: none !important;
        }

        /* Metadata Styles */
        .metadata-section {
            padding: 30px;
            background: var(--bg-card);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }

        .metadata-grid {
            display: grid;
            grid-template-columns: 1fr 280px;
            gap: 40px;
        }

        .meta-info-col {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 24px;
            align-content: start;
        }

        .meta-media-col {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .artist-images-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
        }

        .artist-images-area.multi-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            align-content: start;
        }

        .artist-images-area::-webkit-scrollbar {
            width: 4px;
        }

        .artist-images-area::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .youtube-container {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: black;
            border: 1px solid var(--border-color);
        }

        .yt-label {
            padding: 8px 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
        }

        .meta-image-col::-webkit-scrollbar {
            width: 4px;
        }

        .meta-image-col::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 2px;
        }

        .artist-card {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .artist-image-container {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.4);
            background: var(--bg-dark);
            margin-bottom: 8px;
        }

        /* Check for single image specific styling if needed, but default 100% width works */

        .artist-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* "Fully fit" usually means filling the box elegantly */
            transition: transform 0.5s ease;
        }

        .artist-image:hover {
            transform: scale(1.05);
        }

        .artist-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .meta-links-row {
            grid-column: 1 / -1;
            display: flex;
            gap: 30px;
            margin-top: 10px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        .meta-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .meta-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .meta-value {
            font-size: 1.05rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
        }

        .meta-link {
            color: var(--spotify-green);
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: opacity 0.2s;
        }

        .meta-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* Lyrics Styles (Fresh) */
        .lyrics-container {
            margin-top: 30px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            animation: fadeIn 0.4s ease;
        }

        .lyrics-container.hidden {
            display: none;
        }

        .lyrics-header {
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
        }

        .warning-banner {
            background: rgba(251, 146, 60, 0.1);
            color: #fb923c;
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.85rem;
            border: 1px solid rgba(251, 146, 60, 0.3);
            font-weight: 600;
        }

        .copy-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 6px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .copy-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .lyrics-content {
            white-space: pre-wrap;
            font-family: inherit;
            line-height: 1.8;
            color: var(--text-primary);
            text-align: center;
            max-width: 800px;
            margin: 0 auto;
            font-size: 1.05rem;
        }

        body.apple-active .meta-link {
            color: var(--apple-pink);
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            .metadata-grid {
                grid-template-columns: 1fr;
                gap: 30px;
            }

            .meta-image-col {
                order: -1;
                /* Show image first on mobile */
                max-width: 200px;
                margin: 0 auto;
            }

            .meta-links-row {
                flex-direction: column;
                gap: 20px;
            }
        }

        /* Settings UI */
        .settings-icon-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            z-index: 100;
            padding: 10px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .settings-icon-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .settings-icon-btn svg {
            width: 24px;
            height: 24px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease;
        }

        .settings-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 450px;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            animation: slideDown 0.3s ease;
        }

        /* Settings Guide */
        .guide-collapsible {
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
        }

        .guide-toggle-btn {
            background: none;
            border: none;
            color: var(--spotify-green);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 0.9rem;
            font-weight: 600;
            align-items: center;
            padding: 5px 0;
        }

        .guide-toggle-btn:hover {
            opacity: 0.9;
        }

        .guide-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .guide-content.expanded {
            max-height: 400px;
            margin-top: 10px;
            padding-bottom: 10px;
        }

        .steps-list {
            padding-left: 20px;
            line-height: 1.6;
            margin: 0;
        }

        .steps-list li {
            margin-bottom: 8px;
        }

        .steps-list b {
            color: var(--text-primary);
        }

        .guide-note {
            margin-top: 10px;
            font-style: italic;
            opacity: 0.8;
            font-size: 0.8rem;
        }


        .setting-item {
            margin-bottom: 25px;
        }

        .setting-item label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .setting-item input {
            width: 100%;
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: white;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .setting-item input:focus {
            border-color: var(--spotify-green);
            outline: none;
        }

        .setting-hint {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 8px;
            line-height: 1.4;
        }

        .settings-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .primary-btn {
            background: var(--spotify-green);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .primary-btn:hover {
            transform: scale(1.05);
        }

        .secondary-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .secondary-btn:hover {
            border-color: var(--text-primary);
            color: var(--text-primary);
        }

        /* Copyright Protection */
        .protected-img {
            -webkit-user-drag: none;
            -khtml-user-drag: none;
            -moz-user-drag: none;
            -o-user-drag: none;
            user-drag: none;
            user-select: none;
            pointer-events: auto;
            /* Allow clicks but not drags/selects */
        }

        /* Spam Protection Overlay */
        .spam-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            text-align: center;
            display: none;
        }

        .spam-overlay.active {
            display: flex;
        }

        .spam-title {
            color: #ff6b6b;
            font-size: 2rem;
            margin-bottom: 20px;
        }

        /* Access Lock Overlay */
        .lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 20000;
            /* Higher than spam overlay */
            text-align: center;
        }

        .lock-input {
            background: #333;
            border: 1px solid #444;
            color: #fff;
            padding: 10px 15px;
            font-size: 1.2rem;
            border-radius: 5px;
            margin-bottom: 15px;
            width: 200px;
            text-align: center;
            outline: none;
        }

        .lock-input:focus {
            border-color: #1DB954;
        }

        .hidden {
            display: none !important;
        }
    </style>
</head>

<body class="spotify-active">

    <div id="spamOverlay" class="spam-overlay">
        <div class="spam-title">⚠️ Too Many Clicks</div>
        <p style="color: var(--text-secondary);">Please slow down. Access paused for <span id="spamTimer">10</span>s.
        </p>
    </div>
    <script>
        // Spam Click Detection
        (function () {
            let clickCount = 0;
            const LIMIT = 15;
            const TIME_FRAME = 3000; // 3 secs
            const LOCKOUT_TIME = 10000; // 10 secs
            let resetTimer;

            document.addEventListener('click', (e) => {
                // Ignore clicks inside the overlay itself
                if (e.target.closest('#spamOverlay')) return;

                clickCount++;

                if (clickCount >= LIMIT) {
                    lockoutUser();
                }

                // Reset count if no spam detected within timeframe
                clearTimeout(resetTimer);
                resetTimer = setTimeout(() => {
                    clickCount = 0;
                }, TIME_FRAME);
            }, true);

            function lockoutUser() {
                console.warn('Spam clicks detected');
                const overlay = document.getElementById('spamOverlay');
                const timerEl = document.getElementById('spamTimer');
                if (overlay.classList.contains('active')) return;

                overlay.classList.add('active');

                let remaining = LOCKOUT_TIME / 1000;
                timerEl.textContent = remaining;

                const interval = setInterval(() => {
                    remaining--;
                    timerEl.textContent = remaining;
                    if (remaining <= 0) {
                        clearInterval(interval);
                        overlay.classList.remove('active');
                        clickCount = 0;
                    }
                }, 1000);
            }
        })();
    </script>
    <!-- Animated Background -->
    <div class="background-animation">
        <div class="bg-blob spotify"></div>
        <div class="bg-blob apple"></div>
        <div class="bg-blob secondary"></div>
    </div>

    <div class="container" id="appContent" style="display: none;">
        <!-- Settings Button -->
        <button id="settingsBtn" class="settings-icon-btn" title="Settings">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path
                    d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-.5 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-.5 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-.5 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73v.44a2 2 0 0 1-.5 1.73l-.43.25a2 2 0 0 1-2 0l-.18-.08a2 2 0 0 0-2 0l-.45.26a2 2 0 0 0-1 1.73L12.22 2z">
                </path>
                <circle cx="12" cy="12" r="3"></circle>
            </svg>
        </button>

        <!-- Header -->
        <header class="header">
            <div class="header-title-wrapper">
                <img src="/assets/logo.png" alt="Logo" class="site-logo">
                <h1>Music Playback</h1>
            </div>
            <p>Search and play music from your favorite platform</p>
        </header>

        <!-- User Profile (shown when logged in with Spotify) -->
        <div class="user-profile hidden" id="userProfile">
            <img class="user-avatar" id="userAvatar" src="" alt="Profile">
            <span class="user-name" id="userName">User</span>
            <button class="logout-btn" onclick="logout()" title="Logout">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
            </button>
        </div>

        <!-- Login Section (only shown for Spotify when not logged in) -->
        <div class="login-section hidden" id="loginSection">
            <a href="/api/spotify-login" class="login-btn spotify">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                </svg>
                Login with Spotify
            </a>
            <p class="login-subtitle">Login to play full tracks</p>
        </div>

        <!-- Platform Toggle -->
        <div class="platform-toggle">
            <button class="platform-btn spotify active" onclick="selectPlatform('spotify')">
                <svg class="platform-logo" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                </svg>
                <span class="platform-name">Spotify</span>
            </button>
            <button class="platform-btn apple" onclick="selectPlatform('apple')">
                <svg class="platform-logo" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.106 1.596-.35 2.295-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.042-1.8-.335-2.22-1.09-.46-.827-.19-1.94.69-2.53.38-.254.82-.385 1.264-.497.378-.095.762-.163 1.14-.254.33-.08.53-.29.617-.613.03-.11.04-.225.04-.34-.002-1.633 0-3.265 0-4.898v-.163c-.035.018-.058.027-.078.04l-5.317 1.396v.124c0 2.57 0 5.14-.002 7.71 0 .403-.047.8-.204 1.175-.264.63-.72 1.054-1.378 1.266-.35.113-.72.18-1.09.21-.87.067-1.65-.17-2.2-.86-.67-.84-.52-2.19.32-2.9.394-.327.856-.5 1.34-.613.478-.11.96-.195 1.44-.3.328-.072.538-.27.64-.59.04-.12.06-.25.06-.38V7.47c0-.16.03-.31.1-.46.1-.2.26-.33.47-.39.16-.04.32-.07.48-.1 1.9-.39 3.8-.79 5.69-1.18.21-.05.42-.08.63-.08.38.01.65.25.72.64.02.1.03.2.03.31v3.9z" />
                </svg>
                <span class="platform-name">Apple Music</span>
            </button>
        </div>

        <!-- Search Bar -->
        <div class="search-container">
            <div class="search-wrapper">
                <div class="search-inner">
                    <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                        stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" class="search-input" id="searchInput"
                        placeholder="Search Spotify for songs, artists, albums..." onkeypress="handleKeyPress(event)">
                    <button class="search-btn" onclick="searchMusic()">Search</button>
                </div>
            </div>
        </div>

        <!-- Search Results -->
        <div class="search-results hidden" id="searchResults">
            <h3 class="results-header">Search Results</h3>
            <div class="track-list" id="trackList"></div>
        </div>

        <!-- Player Section -->
        <section class="player-section">
            <h2 class="player-title">Now Playing</h2>
            <div class="embed-container" id="embedContainer">
                <!-- Placeholder -->
                <div class="embed-placeholder" id="placeholder">
                    <svg class="embed-placeholder-icon" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
                    </svg>
                    <p>Search for music to start playing</p>
                </div>

                <!-- Loading -->
                <div class="loading" id="loading">
                    <img src="/assets/logo.png" alt="Loading..." class="loading-logo">
                    <p class="loading-text">Finding your music...</p>
                    <div class="loading-dots">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>

                <!-- Error -->
                <div class="error-message" id="errorMessage"></div>

                <!-- Preview Player (for non-logged-in Spotify users) -->
                <div class="preview-player" id="previewPlayer">
                    <div class="preview-card">
                        <img class="preview-album-art protected-img" id="previewAlbumArt" src="" alt="Album Art"
                            draggable="false" oncontextmenu="return false;">
                        <div class="preview-info">
                            <div class="preview-track-name" id="previewTrackName">Track Name</div>
                            <div class="preview-artist" id="previewArtist">Artist</div>
                            <span class="preview-badge">30s Preview</span>
                        </div>
                    </div>
                    <div class="preview-controls">
                        <button class="preview-play-btn" id="previewPlayBtn" onclick="togglePreview()">
                            <svg id="previewPlayIcon" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z" />
                            </svg>
                        </button>
                        <div class="preview-progress" id="previewProgress" onclick="seekPreview(event)">
                            <div class="preview-progress-bar" id="previewProgressBar"></div>
                        </div>
                        <span class="preview-time" id="previewTime">0:00 / 0:30</span>
                    </div>
                    <div class="preview-login-prompt">
                        <p>Login with your Spotify account to play full tracks</p>
                        <a href="/api/spotify-login" class="preview-login-btn">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                            </svg>
                            Login with Spotify
                        </a>
                    </div>
                    <div class="open-buttons">
                        <a href="#" class="open-btn spotify" id="previewOpenBtn" target="_blank">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                            </svg>
                            Open in Spotify
                        </a>
                    </div>
                </div>

                <!-- Spotify Embed Wrapper (for logged-in users) -->
                <div class="embed-wrapper" id="spotifyWrapper">
                    <iframe id="spotifyEmbed" class="spotify-embed" style="border-radius:12px" src="" width="100%"
                        height="152" frameBorder="0" allowfullscreen=""
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
                        loading="lazy">
                    </iframe>
                    <div class="open-buttons">
                        <a href="#" class="open-btn spotify" id="openSpotifyBtn" target="_blank">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z" />
                            </svg>
                            Open in Spotify
                        </a>
                    </div>
                </div>

                <!-- Apple Music Embed Wrapper -->
                <div class="embed-wrapper" id="appleWrapper">
                    <iframe id="appleEmbed" class="apple-embed" src="" width="100%" height="175" frameBorder="0"
                        allow="autoplay *; encrypted-media *; fullscreen *; clipboard-write"
                        style="border-radius: 12px; overflow: hidden; background: transparent;"
                        sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation">
                    </iframe>
                    <div class="open-buttons">
                        <a href="#" class="open-btn apple" id="openAppleBtn" target="_blank">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path
                                    d="M23.994 6.124a9.23 9.23 0 00-.24-2.19c-.317-1.31-1.062-2.31-2.18-3.043a5.022 5.022 0 00-1.877-.726 10.496 10.496 0 00-1.564-.15c-.04-.003-.083-.01-.124-.013H5.986c-.152.01-.303.017-.455.026-.747.043-1.49.123-2.193.4-1.336.53-2.3 1.452-2.865 2.78-.192.448-.292.925-.363 1.408-.056.392-.088.785-.1 1.18 0 .032-.007.062-.01.093v12.223c.01.14.017.283.027.424.05.815.154 1.624.497 2.373.65 1.42 1.738 2.353 3.234 2.802.42.127.856.187 1.293.228.555.053 1.11.06 1.667.06h11.03a12.5 12.5 0 001.57-.1c.822-.106 1.596-.35 2.295-.81a5.046 5.046 0 001.88-2.207c.186-.42.293-.87.37-1.324.113-.675.138-1.358.137-2.04-.002-3.8 0-7.595-.003-11.393zm-6.423 3.99v5.712c0 .417-.058.827-.244 1.206-.29.59-.76.962-1.388 1.14-.35.1-.706.157-1.07.173-.95.042-1.8-.335-2.22-1.09-.46-.827-.19-1.94.69-2.53.38-.254.82-.385 1.264-.497.378-.095.762-.163 1.14-.254.33-.08.53-.29.617-.613.03-.11.04-.225.04-.34-.002-1.633 0-3.265 0-4.898v-.163c-.035.018-.058.027-.078.04l-5.317 1.396v.124c0 2.57 0 5.14-.002 7.71 0 .403-.047.8-.204 1.175-.264.63-.72 1.054-1.378 1.266-.35.113-.72.18-1.09.21-.87.067-1.65-.17-2.2-.86-.67-.84-.52-2.19.32-2.9.394-.327.856-.5 1.34-.613.478-.11.96-.195 1.44-.3.328-.072.538-.27.64-.59.04-.12.06-.25.06-.38V7.47c0-.16.03-.31.1-.46.1-.2.26-.33.47-.39.16-.04.32-.07.48-.1 1.9-.39 3.8-.79 5.69-1.18.21-.05.42-.08.63-.08.38.01.65.25.72.64.02.1.03.2.03.31v3.9z" />
                            </svg>
                            Open in Apple Music
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Metadata Section -->
        <section class="metadata-section hidden" id="metadataSection">
            <h2 class="player-title">Metadata</h2>
            <div class="metadata-grid">
                <!-- Left Column: Info -->
                <div class="meta-info-col">
                    <div class="meta-item">
                        <span class="meta-label">Track Title</span>
                        <span class="meta-value" id="metaTitle">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Artist</span>
                        <span class="meta-value" id="metaArtist">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Album</span>
                        <span class="meta-value" id="metaAlbum">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Duration</span>
                        <span class="meta-value" id="metaDuration">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Release Date</span>
                        <span class="meta-value" id="metaReleased">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Genre</span>
                        <span class="meta-value" id="metaGenre">Loading...</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Language</span>
                        <a href="#" target="_blank" class="meta-link" id="metaLanguage">-</a>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">Label</span>
                        <span class="meta-value" id="metaLabel">-</span>
                    </div>
                    <div class="meta-item">
                        <span class="meta-label">ISRC</span>
                        <span class="meta-value" id="metaISRC">-</span>
                    </div>

                    <!-- Links Row -->
                    <div class="meta-links-row">
                        <a href="#" target="_blank" class="meta-link" id="metaSpotifyLink">View on Spotify</a>
                        <a href="#" target="_blank" class="meta-link" id="metaAppleLink">View on Apple Music</a>
                        <a href="#" target="_blank" class="meta-link" id="metaMusixmatch">View Lyrics</a>
                        <a href="#" class="meta-link" id="refLyricsBtn" style="color: #fb923c;">Reference Lyrics</a>
                    </div>
                </div>

                <!-- Right Column: Media (Artists + YouTube) -->
                <div class="meta-media-col">
                    <!-- Artist Images -->
                    <div id="artistImagesContainer" class="artist-images-area">
                        <div class="artist-image-container">
                            <img id="metaArtistImage" class="artist-image protected-img" src="" alt="Artist"
                                onerror="this.style.display='none'" draggable="false" oncontextmenu="return false;">
                        </div>
                        <div class="artist-label">Artist</div>
                    </div>

                    <!-- YouTube Embed -->
                    <div class="youtube-container" id="youtubeContainer">
                        <div class="yt-label">Official Video</div>
                        <iframe id="youtubeEmbed" width="100%" height="150" src="" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen>
                        </iframe>
                    </div>
                </div>
            </div>
        </section>

        <!-- Lyrics Section (Fresh Implementation) -->
        <section id="lyricsContainer" class="lyrics-container hidden">
            <div class="lyrics-header">
                <div class="warning-banner">⚠️ Intended for reference purposes only</div>
                <button id="copyLyricsBtn" class="copy-btn">Copy</button>
            </div>
            <div id="lyricsText" class="lyrics-content">Loading...</div>
        </section>
        <!-- Footer -->
        <footer
            style="margin-top: 60px; padding-bottom: 20px; text-align: center; border-top: 1px solid var(--border-color); padding-top: 20px;">
            <a href="privacy.html"
                style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; margin-bottom: 10px; display: inline-block;">Privacy
                Policy</a>
            <p style="color: var(--text-secondary); font-size: 0.75rem; opacity: 0.5;">&copy; 2026 Music Playback. All
                rights reserved.</p>
            <p
                style="color: var(--text-secondary); font-size: 0.7rem; opacity: 0.4; max-width: 600px; margin: 5px auto 0;">
                This website is an independent project and is not affiliated, associated, authorized, endorsed by, or in
                any way officially connected with Spotify, Apple Music, YouTube, or any of their subsidiaries or
                affiliates.</p>
        </footer>
    </div>

    <!-- Hidden Audio Element for Preview -->
    <audio id="previewAudio" preload="none"></audio>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay hidden">
        <div class="settings-card">
            <h3 style="font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                ⚙️ Playback Settings
            </h3>
            <div style="height: 1px; background: var(--border-color); margin: 15px 0 20px;"></div>

            <div class="setting-item">
                <label for="ytApiKeyInput">YouTube Data API Key</label>
                <input type="password" id="ytApiKeyInput" placeholder="Paste your API Key here">
                <p class="setting-hint">
                    Required to play official music videos.
                    <br>
                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank"
                        style="color:var(--spotify-green); text-decoration: none; display: inline-block; margin-top: 5px;">Get
                        a Key &#8599;</a>
                </p>
                <p style="font-size:0.75rem; color:var(--text-secondary); margin-top:8px; opacity: 0.7;">
                    🔒 Key is stored <b>locally</b> on your device and never sent to our server.
                </p>
            </div>

            <div class="guide-collapsible">
                <button id="toggleGuideBtn" class="guide-toggle-btn">
                    <span>❓ How to get a YouTube API Key</span>
                    <span id="guideArrow" style="transition: transform 0.3s;">▼</span>
                </button>
                <div id="guideContent" class="guide-content">
                    <ol class="steps-list">
                        <li>Go to <a href="https://console.cloud.google.com/" target="_blank"
                                style="color:var(--spotify-green)">Google Cloud Console</a>.</li>
                        <li>Create a new <b>Project</b> (e.g., "Music App").</li>
                        <li>Go to <b>APIs & Services > Library</b>.</li>
                        <li>Search for "YouTube Data API v3" and click <b>Enable</b>.</li>
                        <li>Go to <b>Credentials > Create Credentials > API Key</b>.</li>
                        <li>Copy the key and paste it above!</li>
                    </ol>
                    <p class="guide-note">✨ It's free (10k daily quota) and requires no approval.</p>
                </div>
            </div>

            <!-- Actions Row -->
            <div class="settings-actions" style="margin-top: 30px; margin-bottom: 20px;">
                <button id="deleteKeyBtn" class="secondary-btn"
                    style="margin-right: auto; color: #ff6b6b; border-color: rgba(255, 107, 107, 0.3);">Delete</button>
                <button id="closeSettingsBtn" class="secondary-btn">Cancel</button>
                <button id="saveSettingsBtn" class="primary-btn">Save Key</button>
            </div>

            <!-- Diagnostics Section (Footer) -->
            <div class="setting-item"
                style="border-top: 1px solid var(--border-color); padding-top: 15px; margin-bottom: 0;">
                <label style="color: var(--text-secondary); font-size: 0.85rem;">Troubleshooting</label>
                <button id="internalCopyLogBtn" class="secondary-btn"
                    style="width: 100%; font-size: 0.85rem; padding: 8px;">
                    📋 Copy Diagnostic Info
                </button>
                <p id="internalClipConfirm"
                    style="color: var(--spotify-green); font-size: 0.8rem; height: 1.2em; opacity: 0; text-align: center; margin-top: 5px; transition: opacity 0.3s;">
                    Copied to clipboard!</p>
            </div>
        </div>
    </div>

    <script>
        let currentPlatform = 'spotify';
        let selectedTrack = null;
        let spotifyUser = null;
        let previewAudio = null;
        let isPlaying = false;

        // Check for OAuth callback tokens in URL hash
        function checkAuthCallback() {
            const hash = window.location.hash.substring(1);
            if (hash) {
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');
                const userName = params.get('user_name');
                const userImage = params.get('user_image');

                if (accessToken) {
                    spotifyUser = {
                        accessToken,
                        refreshToken: params.get('refresh_token'),
                        expiresIn: params.get('expires_in'),
                        name: userName || 'User',
                        image: userImage || ''
                    };

                    localStorage.setItem('spotify_user', JSON.stringify(spotifyUser));
                    history.replaceState(null, '', window.location.pathname);
                    updateUI();
                }
            }
        }

        function checkStoredUser() {
            const stored = localStorage.getItem('spotify_user');
            if (stored) {
                spotifyUser = JSON.parse(stored);
                updateUI();
            }
        }

        function updateUI() {
            const loginSection = document.getElementById('loginSection');
            const userProfile = document.getElementById('userProfile');

            // Only show login/profile for Spotify
            if (currentPlatform === 'spotify') {
                if (spotifyUser) {
                    loginSection.classList.add('hidden');
                    userProfile.classList.remove('hidden');
                    document.getElementById('userName').textContent = spotifyUser.name;
                    document.getElementById('userAvatar').src = spotifyUser.image ||
                        'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23666"><circle cx="12" cy="8" r="4"/><path d="M12 14c-6 0-8 3-8 6v2h16v-2c0-3-2-6-8-6z"/></svg>';
                } else {
                    loginSection.classList.remove('hidden');
                    userProfile.classList.add('hidden');
                }
            } else {
                // Hide both for Apple Music
                loginSection.classList.add('hidden');
                userProfile.classList.add('hidden');
            }
        }

        function logout() {
            spotifyUser = null;
            localStorage.removeItem('spotify_user');
            updateUI();
            // Reset player if showing Spotify content
            if (currentPlatform === 'spotify') {
                hideAllEmbeds();
                showPlaceholder('Search for music on Spotify');
            }
        }

        function selectPlatform(platform) {
            currentPlatform = platform;
            selectedTrack = null;

            // Stop any playing preview
            stopPreview();

            // Allow time for fade out effect before stopping playback
            if (platform === 'spotify') {
                // Switching TO Spotify -> Stop Apple Music
                const appleEmbed = document.getElementById('appleEmbed');
                // Store src if needed later, but for now just clear to stop playback
                if (appleEmbed) appleEmbed.src = '';
            } else {
                // Switching TO Apple Music -> Stop Spotify
                const spotifyEmbed = document.getElementById('spotifyEmbed');
                if (spotifyEmbed) spotifyEmbed.src = '';
            }

            document.body.classList.remove('spotify-active', 'apple-active');
            document.body.classList.add(`${platform}-active`);

            document.querySelectorAll('.platform-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.platform-btn.${platform}`).classList.add('active');

            document.getElementById('searchInput').placeholder =
                `Search ${platform === 'spotify' ? 'Spotify' : 'Apple Music'} for songs, artists, albums...`;

            // Update login section visibility
            updateUI();

            hideSearchResults();
            hideAllEmbeds();
            showPlaceholder(`Search for music on ${platform === 'spotify' ? 'Spotify' : 'Apple Music'}`);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') searchMusic();
        }

        function formatDuration(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000);
            return `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function hideAllEmbeds() {
            document.getElementById('spotifyWrapper').classList.remove('active');
            document.getElementById('appleWrapper').classList.remove('active');
            document.getElementById('previewPlayer').classList.remove('active');
            document.getElementById('loading').classList.remove('active');
            document.getElementById('errorMessage').classList.remove('active');
            stopPreview();
        }

        function hideSearchResults() {
            document.getElementById('searchResults').classList.add('hidden');
        }

        function showSearchResults() {
            document.getElementById('searchResults').classList.remove('hidden');
        }

        function showPlaceholder(message) {
            const placeholder = document.getElementById('placeholder');
            placeholder.querySelector('p').textContent = message;
            placeholder.style.display = 'block';
        }

        function hidePlaceholder() {
            document.getElementById('placeholder').style.display = 'none';
        }

        function showError(message) {
            hideAllEmbeds();
            hidePlaceholder();
            const errorEl = document.getElementById('errorMessage');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        // Preview Player Functions
        function initPreviewAudio() {
            previewAudio = document.getElementById('previewAudio');
            previewAudio.addEventListener('timeupdate', updatePreviewProgress);
            previewAudio.addEventListener('ended', () => {
                isPlaying = false;
                updatePlayButton();
            });
        }

        function togglePreview() {
            if (!previewAudio || !previewAudio.src) return;

            if (isPlaying) {
                previewAudio.pause();
            } else {
                previewAudio.play();
            }
            isPlaying = !isPlaying;
            updatePlayButton();
        }

        function stopPreview() {
            if (previewAudio) {
                previewAudio.pause();
                previewAudio.currentTime = 0;
                isPlaying = false;
                updatePlayButton();
            }
        }

        function updatePlayButton() {
            const icon = document.getElementById('previewPlayIcon');
            if (isPlaying) {
                icon.innerHTML = '<path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>';
            } else {
                icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
            }
        }

        function updatePreviewProgress() {
            if (!previewAudio) return;
            const progress = (previewAudio.currentTime / previewAudio.duration) * 100;
            document.getElementById('previewProgressBar').style.width = progress + '%';

            const current = Math.floor(previewAudio.currentTime);
            const total = Math.floor(previewAudio.duration) || 30;
            document.getElementById('previewTime').textContent =
                `0:${current.toString().padStart(2, '0')} / 0:${total.toString().padStart(2, '0')}`;
        }

        function seekPreview(event) {
            if (!previewAudio || !previewAudio.duration) return;
            const rect = event.target.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            previewAudio.currentTime = percent * previewAudio.duration;
        }

        async function searchMusic() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            hideAllEmbeds();
            hidePlaceholder();
            document.getElementById('loading').classList.add('active');
            hideSearchResults();

            try {
                const apiEndpoint = currentPlatform === 'spotify'
                    ? `/api/spotify-search?q=${encodeURIComponent(query)}&limit=8`
                    : `/api/apple-search?q=${encodeURIComponent(query)}&limit=8`;

                const response = await fetch(apiEndpoint);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Search failed');
                }

                document.getElementById('loading').classList.remove('active');

                if (data.tracks && data.tracks.length > 0) {
                    renderTrackList(data.tracks);
                    showPlaceholder('Select a song to play');
                } else {
                    showPlaceholder('No results found. Try a different search.');
                }

            } catch (error) {
                console.error('Search error:', error);
                document.getElementById('loading').classList.remove('active');
                showError(`Search failed: ${error.message}`);
            }
        }

        // Security: Prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            return String(text)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function renderTrackList(tracks) {
            const trackList = document.getElementById('trackList');
            trackList.innerHTML = '';

            tracks.forEach(track => {
                const trackEl = document.createElement('div');
                trackEl.className = 'track-item';
                trackEl.dataset.trackId = track.id;

                // Use escapeHtml for all dynamic text to prevent XSS
                trackEl.innerHTML = `
                    <img class="track-image protected-img" src="${track.image || 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect fill=%22%232a2a2a%22 width=%22100%22 height=%22100%22/></svg>'}" 
                        alt="${escapeHtml(track.name)}"
                        draggable="false"
                        oncontextmenu="return false;">
                    <div class="track-info">
                        <div class="track-name">${escapeHtml(track.name)}</div>
                        <div class="track-artist">${escapeHtml(track.artist)}</div>
                    </div>
                    <div class="track-duration">${formatDuration(track.duration)}</div>
                `;

                trackEl.addEventListener('click', () => selectTrack(track));
                trackList.appendChild(trackEl);
            });

            showSearchResults();
        }

        function selectTrack(track) {
            selectedTrack = track;
            stopPreview();

            document.querySelectorAll('.track-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.track-item[data-track-id="${track.id}"]`)?.classList.add('selected');

            hideSearchResults();
            hidePlaceholder();
            document.getElementById('errorMessage').classList.remove('active');

            if (currentPlatform === 'spotify') {
                // Use Iframe API if available
                if (embedController) {
                    loadAndPlaySpotify(track.id);
                } else {
                    if (typeof debugLog === 'function') debugLog('Controller not ready, queuing track...');
                    else console.log('Controller not ready, queuing track...');
                    pendingSpotifyTrack = track.id;
                    // Fallback to standard embed temporarily so user sees something
                    const spotifyEmbed = document.getElementById('spotifyEmbed');
                    spotifyEmbed.src = `https://open.spotify.com/embed/track/${track.id}?utm_source=generator&theme=0&autoplay=1`;
                }

                document.getElementById('openSpotifyBtn').href = track.spotifyUrl || `https://open.spotify.com/track/${track.id}`;
                document.getElementById('appleWrapper').classList.remove('active');
                document.getElementById('previewPlayer').classList.remove('active');
                document.getElementById('spotifyWrapper').classList.add('active');
            } else {
                // Apple Music
                const appleEmbed = document.getElementById('appleEmbed');
                appleEmbed.src = `https://embed.music.apple.com/us/song/${track.id}`;
                document.getElementById('openAppleBtn').href = track.appleUrl || `https://music.apple.com/song/${track.id}`;
                document.getElementById('spotifyWrapper').classList.remove('active');
                document.getElementById('previewPlayer').classList.remove('active');
                document.getElementById('appleWrapper').classList.add('active');
            }

            // Fetch and show metadata
            fetchMetadata(track);
        }

        async function fetchMetadata(track) {
            const metaSection = document.getElementById('metadataSection');
            metaSection.classList.remove('hidden');

            // Reset UI with loaders
            const setLoad = (id) => {
                const el = document.getElementById(id);
                if (el) el.textContent = 'Loading...';
            };
            setLoad('metaTitle');
            setLoad('metaArtist');
            setLoad('metaAlbum');
            setLoad('metaReleased');
            setLoad('metaDuration');
            setLoad('metaGenre');
            setLoad('metaLanguage');
            setLoad('metaLabel');
            setLoad('metaISRC');

            const spoLink = document.getElementById('metaSpotifyLink');
            const appLink = document.getElementById('metaAppleLink');
            const lyricLink = document.getElementById('metaMusixmatch');
            const img = document.getElementById('metaArtistImage');

            if (spoLink) spoLink.textContent = 'Loading...';
            if (appLink) appLink.textContent = 'Loading...';
            if (lyricLink) lyricLink.textContent = 'Loading...';

            if (img) {
                img.src = '';
                img.style.display = 'none';
            }

            // Set immediate values if available from the track object
            if (track.name) document.getElementById('metaTitle').textContent = track.name;
            if (track.artist) document.getElementById('metaArtist').textContent = track.artist;
            if (track.album) document.getElementById('metaAlbum').textContent = track.album;

            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);

                const response = await fetch(`/api/get-metadata?id=${track.id}&platform=${currentPlatform}`, {
                    signal: controller.signal
                });
                clearTimeout(timeoutId);

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to fetch metadata');
                }

                // Populate Fields
                document.getElementById('metaTitle').textContent = data.title || track.name || 'N/A';
                document.getElementById('metaArtist').textContent = data.artist || track.artist || 'N/A';
                document.getElementById('metaAlbum').textContent = data.album || 'N/A';

                let dateStr = data.releaseDate || 'N/A';
                if (data.year && data.releaseDate && !data.releaseDate.includes(data.year)) {
                    dateStr += ` (${data.year})`;
                }
                document.getElementById('metaReleased').textContent = dateStr;

                document.getElementById('metaDuration').textContent = data.duration ? formatDuration(data.duration) : 'N/A';
                // Genre
                if (data.genre && data.genre.length > 0) {
                    document.getElementById('metaGenre').textContent = data.genre.slice(0, 3).map(g =>
                        g.charAt(0).toUpperCase() + g.slice(1)
                    ).join(', ');
                } else {
                    document.getElementById('metaGenre').textContent = 'N/A';
                }

                const langEl = document.getElementById('metaLanguage');
                langEl.textContent = 'Click here'; // Keep text static as requested previously

                // Use only primary artist to keep query short
                const mainArtist = track.artist ? track.artist.split(',')[0].trim() : '';
                const langQuery = `${track.name} ${mainArtist} which language?`;

                langEl.href = `https://www.google.com/search?q=${encodeURIComponent(langQuery)}`;
                document.getElementById('metaLabel').textContent = data.recordLabel || 'N/A';
                document.getElementById('metaISRC').textContent = data.isrc || 'N/A';

                // Artist Images (Wikidata Multi-Artist)
                const artistContainer = document.getElementById('artistImagesContainer');
                if (artistContainer) {
                    artistContainer.innerHTML = ''; // Clear previous

                    if (data.artistImages && data.artistImages.length > 0) {
                        // Toggle Grid vs Single layout
                        if (data.artistImages.length > 1) {
                            artistContainer.classList.add('multi-grid');
                        } else {
                            artistContainer.classList.remove('multi-grid');
                        }

                        data.artistImages.forEach(artist => {
                            const card = document.createElement('div');
                            card.className = 'artist-card';
                            card.innerHTML = `
                                <div class="artist-image-container">
                                    <img class="artist-image protected-img" src="${artist.url}" 
                                        alt="${escapeHtml(artist.name)}" 
                                        onerror="this.src='data:image/svg+xml;base64,...'"
                                        draggable="false"
                                        oncontextmenu="return false;">
                                </div>
                                <div class="artist-label">${escapeHtml(artist.name)}</div>
                            `;
                            artistContainer.appendChild(card);
                        });
                    } else {
                        artistContainer.classList.remove('multi-grid');
                        // Fallback placeholder
                        artistContainer.innerHTML = `
                             <div class="artist-image-container"></div>
                             <div class="artist-label">No Image</div>
                         `;
                    }
                }

                // YouTube Embed (BYOK)
                const ytContainer = document.getElementById('youtubeContainer');

                if (ytContainer) {
                    ytContainer.classList.remove('hidden');

                    // Client-side search (requires User Key)
                    const query = `${track.name} ${track.artist} official video`;
                    const ytResult = await searchYouTubeClient(query);

                    if (ytResult.error === 'missing_key') {
                        ytContainer.innerHTML = `
                            <div class="yt-label">Official Video</div>
                            <div style="height:150px; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:10px; background:#000; color:var(--text-secondary); text-align:center; padding:15px;">
                                <span style="font-size:0.85rem;">API Key required for playback</span>
                                <button onclick="document.getElementById('settingsBtn').click()" class="secondary-btn" style="padding:4px 12px; font-size:0.8rem;">Add Key</button>
                            </div>
                        `;
                    } else if (ytResult.error) {
                        ytContainer.innerHTML = `
                            <div class="yt-label">Video Error</div>
                            <div style="height:150px; display:flex; align-items:center; justify-content:center; background:#000; color:#ff6b6b; padding:20px; text-align:center;">
                                <p style="font-size:0.8rem;">${ytResult.message.includes('quota') ? 'Daily Quota Exceeded' : 'Connection Error'}</p>
                            </div>
                        `;
                    } else if (ytResult.id) {
                        ytContainer.innerHTML = `
                            <div class="yt-label">Official Video</div>
                            <iframe id="youtubeEmbed" width="100%" height="150" src="https://www.youtube.com/embed/${ytResult.id}" frameborder="0"
                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                            allowfullscreen></iframe>
                        `;
                    } else {
                        ytContainer.innerHTML = `
                            <div class="yt-label">Official Video</div>
                            <div style="height:150px; display:flex; align-items:center; justify-content:center; background:#000; color:var(--text-secondary);">
                                <p style="font-size:0.9rem;">No video found</p>
                            </div>
                        `;
                    }
                }

                // Links
                if (data.crossLinks.spotify && spoLink) {
                    spoLink.textContent = 'View on Spotify';
                    spoLink.href = data.crossLinks.spotify;
                } else if (spoLink) {
                    spoLink.textContent = 'Not found';
                    spoLink.href = '#';
                }

                if (data.crossLinks.apple && appLink) {
                    appLink.textContent = 'View on Apple Music';
                    appLink.href = data.crossLinks.apple;
                } else if (appLink) {
                    appLink.textContent = 'Not found';
                    appLink.href = '#';
                }

                // Language Link
                if (langEl) {
                    langEl.textContent = 'Click here';
                }

                if (data.musixmatch && lyricLink) {
                    lyricLink.textContent = 'View Lyrics';
                    lyricLink.href = data.musixmatch;
                } else if (lyricLink) {
                    lyricLink.textContent = 'N/A';
                    lyricLink.href = '#';
                }

            } catch (error) {
                console.error('Metadata error:', error);
                const els = ['metaGenre', 'metaReleased', 'metaDuration', 'metaLanguage', 'metaLabel', 'metaISRC'];
                els.forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = '-';
                });
                if (spoLink) spoLink.textContent = '-';
                if (appLink) appLink.textContent = '-';
                if (lyricLink) lyricLink.textContent = '-';
            }
        }

        // Lyrics Feature Logic (Fresh)
        function initLyricsFeature() {
            const btn = document.getElementById('refLyricsBtn');
            const container = document.getElementById('lyricsContainer');
            const content = document.getElementById('lyricsText');
            const copyBtn = document.getElementById('copyLyricsBtn');

            if (!btn || !container) return;

            // Toggle
            btn.addEventListener('click', async (e) => {
                e.preventDefault();

                if (!container.classList.contains('hidden')) {
                    container.classList.add('hidden');
                    return;
                }

                container.classList.remove('hidden');

                // Scroll to view
                setTimeout(() => {
                    container.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);

                if (!selectedTrack) {
                    content.textContent = 'Please select a track first.';
                    return;
                }

                content.textContent = 'Fetching lyrics from LRCLIB...';

                try {
                    const artistName = selectedTrack.artist.split(',')[0].trim();
                    const query = new URLSearchParams({
                        title: selectedTrack.name,
                        artist: artistName,
                        duration: selectedTrack.duration
                    });

                    const res = await fetch(`/api/get-lyrics?${query.toString()}`);
                    const data = await res.json();

                    if (res.ok && data.plainLyrics) {
                        content.textContent = data.plainLyrics;
                    } else {
                        content.textContent = 'Lyrics not found for this track.';
                    }
                } catch (err) {
                    console.error('Lyrics error:', err);
                    content.textContent = 'Failed to load lyrics.';
                }
            });

            // Copy
            if (copyBtn) {
                copyBtn.addEventListener('click', () => {
                    const text = content.textContent;
                    if (!text || text.includes('Loading...')) return;

                    navigator.clipboard.writeText(text).then(() => {
                        const originalText = copyBtn.textContent;
                        copyBtn.textContent = 'Copied!';
                        setTimeout(() => copyBtn.textContent = originalText, 2000);
                    }).catch(err => console.error('Copy failed:', err));
                });
            }
        }

        // Settings Logic
        function initSettings() {
            const settingsModal = document.getElementById('settingsModal');
            const settingsBtn = document.getElementById('settingsBtn');
            const ytInput = document.getElementById('ytApiKeyInput');
            const saveBtn = document.getElementById('saveSettingsBtn');
            const closeBtn = document.getElementById('closeSettingsBtn');
            const deleteBtn = document.getElementById('deleteKeyBtn');
            const toggleGuideBtn = document.getElementById('toggleGuideBtn');
            const guideContent = document.getElementById('guideContent');
            const guideArrow = document.getElementById('guideArrow');

            if (!settingsBtn) return;

            settingsBtn.addEventListener('click', () => {
                ytInput.value = localStorage.getItem('yt_api_key') || '';
                settingsModal.classList.remove('hidden');
            });

            closeBtn.addEventListener('click', () => settingsModal.classList.add('hidden'));

            // Guide Toggle
            if (toggleGuideBtn && guideContent && guideArrow) {
                toggleGuideBtn.addEventListener('click', () => {
                    guideContent.classList.toggle('expanded');
                    const isExpanded = guideContent.classList.contains('expanded');
                    guideArrow.style.transform = isExpanded ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            }

            // Save functionality
            saveBtn.addEventListener('click', () => {
                const key = ytInput.value.trim();
                if (key) {
                    localStorage.setItem('yt_api_key', key);
                    settingsModal.classList.add('hidden');
                    // Retry video if track selected
                    if (selectedTrack) {
                        const ytContainer = document.getElementById('youtubeContainer');
                        const ytEmbed = document.getElementById('youtubeEmbed');
                        // If container is visible but empty/error, retry
                        if (ytContainer && !ytContainer.classList.contains('hidden')) {
                            fetchMetadata(selectedTrack);
                        }
                    }
                } else {
                    alert('Please enter a valid key.');
                }
            });

            // Delete functionality
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => {
                    if (confirm('Are you sure you want to remove your API Key from this device?')) {
                        localStorage.removeItem('yt_api_key');
                        ytInput.value = '';
                        alert('Key removed from local storage.');
                        settingsModal.classList.add('hidden');
                    }
                });
            }

            // Diagnostics Copy
            const internalCopyBtn = document.getElementById('internalCopyLogBtn');
            const internalConfirm = document.getElementById('internalClipConfirm');
            if (internalCopyBtn) {
                internalCopyBtn.addEventListener('click', () => {
                    const diag = {
                        timestamp: new Date().toISOString(),
                        userAgent: navigator.userAgent,
                        screen: window.innerWidth + 'x' + window.innerHeight,
                        platform: currentPlatform,
                        hasDeviceID: !!localStorage.getItem('device_binding_id'),
                        deviceID: localStorage.getItem('device_binding_id'),
                        hasYTKey: !!localStorage.getItem('yt_api_key'), // SECURE: Only copies true/false
                        authCookie: document.cookie.includes('auth_token'),
                        referrer: document.referrer
                    };

                    navigator.clipboard.writeText(JSON.stringify(diag, null, 2)).then(() => {
                        internalConfirm.style.opacity = '1';
                        setTimeout(() => internalConfirm.style.opacity = '0', 2000);
                    });
                });
            }
        }

        // Official YouTube Search (Client-Side)
        async function searchYouTubeClient(query) {
            const apiKey = localStorage.getItem('yt_api_key');
            if (!apiKey) return { error: 'missing_key' };

            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(query)}&type=video&maxResults=1&key=${apiKey}`);
                const data = await res.json();

                if (data.error) throw new Error(data.error.message);

                if (data.items && data.items.length > 0) {
                    return { id: data.items[0].id.videoId };
                }
                return { id: null };
            } catch (err) {
                console.error('YouTube API Error:', err);
                return { error: 'api_error', message: err.message };
            }
        }

        // Debug Helper
        function debugLog(msg) {
            // Visual log removed
            console.log(msg);
        }

        // Spotify Iframe API
        let embedController = null;
        let pendingSpotifyTrack = null;

        window.onSpotifyIframeApiReady = (IFrameAPI) => {
            debugLog('Spotify API Ready');
            const element = document.getElementById('spotifyEmbed');
            const options = {
                uri: 'spotify:track:4cOdK2wGLETKBW3PvgPWqT', // Placeholder
                width: '100%',
                height: '152',
                theme: '0'
            };
            const callback = (EmbedController) => {
                debugLog('EmbedController Created');
                embedController = EmbedController;

                // Check if a track was waiting for the controller
                if (pendingSpotifyTrack) {
                    debugLog('Found pending track, loading...');
                    loadAndPlaySpotify(pendingSpotifyTrack);
                    pendingSpotifyTrack = null;
                }
            };
            IFrameAPI.createController(element, options, callback);
        };

        function loadAndPlaySpotify(trackId) {
            if (!embedController) {
                debugLog('Error: Controller missing during load attempt');
                return;
            }

            debugLog(`Loading URI: spotify:track:${trackId}`);
            embedController.loadUri(`spotify:track:${trackId}`);
            document.getElementById('spotifyWrapper').classList.add('active');

            // "Trigger autoclick once after 2 seconds" logic
            debugLog('Scheduling play in 2s...');
            setTimeout(() => {
                debugLog('Attempting embedController.play()...');
                embedController.play(); // No promise returned by this API usually, but we capture flow
                // Add a follow-up check
                setTimeout(() => debugLog('Play command sent. If no sound, Browser Policy likely blocked it.'), 500);
            }, 2000);
        }

        // URL Parameters Handler (Auto-Search/Play)
        async function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const query = params.get('q') || params.get('search');

            if (query) {
                debugLog(`Found query: ${query}`);
                const searchInput = document.getElementById('searchInput');
                searchInput.value = query;

                // Trigger search
                await searchMusic();

                // Auto-select first result if available
                const trackList = document.getElementById('trackList');
                if (trackList && trackList.firstChild) {
                    debugLog('Auto-selecting first result');
                    trackList.firstChild.click();
                } else {
                    debugLog('No results found to select');
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initPreviewAudio();
            initLyricsFeature();
            initSettings();
            checkAuthCallback();
            checkStoredUser();
            selectPlatform('spotify');

            // Check for external search query
            checkUrlParams();
        });
    </script>
    <script src="https://open.spotify.com/embed/iframe-api/v1" async></script>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <!-- Access Code Overlay -->
    <div id="accessOverlay" class="access-overlay">
        <div class="access-card">
            <div class="access-icon">🔒</div>
            <h2>Private Access</h2>

            <!-- Step 1: Discord Login -->
            <div id="discordLoginStep">
                <p style="color: #ccc; margin-bottom: 20px;">Please login with Discord to continue.</p>
                <a href="/api/auth/discord" class="spotify-auth-btn"
                    style="background: #5865F2; width: 100%; justify-content: center; box-sizing: border-box; text-decoration: none; display: flex; align-items: center; gap: 10px; padding: 12px; border-radius: 50px; font-weight: 600; font-size: 1rem;">
                    <svg viewBox="0 0 127.14 96.36" fill="white" style="width: 24px; height: 24px;">
                        <path
                            d="M107.7,8.07A105.15,105.15,0,0,0,81.47,0a72.06,72.06,0,0,0-3.36,6.83A97.68,97.68,0,0,0,49,6.83,72.37,72.37,0,0,0,45.64,0,105.89,105.89,0,0,0,19.39,8.09C2.79,32.65-1.71,56.6.54,80.21h0A105.73,105.73,0,0,0,32.71,96.36,77.11,77.11,0,0,0,39.6,85.25a68.42,68.42,0,0,1-10.85-5.18c.91-.66,1.8-1.34,2.66-2a75.57,75.57,0,0,0,64.32,0c.87.71,1.76,1.39,2.66,2a68.68,68.68,0,0,1-10.87,5.19,77,77,0,0,0,6.89,11.1A105.89,105.89,0,0,0,126.6,80.22c1.25-23.6-3.26-47.56-18.9-72.15ZM42.45,65.69C36.18,65.69,31,60,31,53s5-12.74,11.43-12.74S54,46,53.89,53,48.84,65.69,42.45,65.69Zm42.24,0C78.41,65.69,73.25,60,73.25,53s5.18-12.74,11.44-12.74S96.23,46,96.12,53,91.08,65.69,84.69,65.69Z" />
                    </svg>
                    Login with Discord
                </a>

                <div style="margin-top: 25px; border-top: 1px solid #333; padding-top: 20px;">
                    <p style="font-size: 0.8rem; color: #888; margin-bottom: 10px;">
                        Or continue without Discord (Device Only)
                    </p>
                    <button id="skipDiscordBtn" class="secondary-btn small"
                        style="background: transparent; border: 1px solid #555; font-size: 0.9rem; width: 100%;">
                        Continue without Discord
                    </button>
                    <p style="font-size: 0.75rem; color: #666; margin-top: 10px; line-height: 1.4;">
                        <span style="color: #ffaa00;">Warning:</span> Access and API Keys entered later will be stored
                        in this browser only.
                        You will lose access if you clear data or uninstall the browser.
                    </p>
                </div>
            </div>

            <!-- Step 2: Code Entry -->
            <div id="codeEntryStep" class="hidden">
                <div class="user-preview"
                    style="margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; background: #222; padding: 8px 16px; border-radius: 50px; width: fit-content; margin-inline: auto;">
                    <img id="discordAvatar" src="" alt="" style="width: 24px; height: 24px; border-radius: 50%;">
                    <span id="discordUsername" style="color: #5865F2; font-weight: 600; font-size: 0.9rem;"></span>
                </div>

                <div class="access-input-wrapper" style="flex-direction: column;">
                    <input type="text" id="accessNameInput" placeholder="Your Name" class="access-field"
                        style="margin-bottom: 10px; text-align: center;">
                    <input type="text" id="accessCodeInput" placeholder="Access Code" autocomplete="off"
                        class="access-field"
                        style="text-align: center; letter-spacing: 2px; text-transform: uppercase;">
                </div>

                <button id="accessSubmitBtn" class="full-width-btn">Unlock Access</button>
            </div>

            <div class="error-wrapper" style="margin-top: 15px;">
                <p id="accessError" class="access-error"></p>
                <button id="copyLogBtn" class="secondary-btn small hidden"
                    style="margin-top: 10px; font-size: 0.8rem; padding: 5px 10px;">📋 Copy Error Log</button>
            </div>

            <p id="clipConfirm"
                style="color: var(--spotify-green); font-size: 0.8rem; height: 1.2em; opacity: 0; transition: opacity 0.3s;">
                Copied to clipboard!</p>
        </div>
    </div>

    <style>
        .access-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .access-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .access-card {
            background: #111;
            border: 1px solid #333;
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .access-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .access-card h2 {
            margin-bottom: 10px;
            font-size: 1.5rem;
        }

        .access-card p {
            color: #888;
            margin-bottom: 30px;
        }

        .access-input-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .access-field {
            width: 100%;
            background: #222;
            border: 1px solid #333;
            padding: 12px 15px;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
            box-sizing: border-box;
            /* Fix padding width issue */
        }

        .access-field:focus {
            border-color: var(--spotify-green);
        }

        .full-width-btn {
            background: var(--spotify-green);
            color: white;
            border: none;
            width: 100%;
            padding: 12px;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }

        .full-width-btn:hover {
            transform: scale(1.02);
            background: #1ed760;
        }

        .access-error {
            color: #ff4d4d;
            font-size: 0.9rem;
            min-height: 20px;
            margin-top: 15px;
        }

        .spotify-auth-btn {
            background: #1DB954;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.2s;
        }

        .spotify-auth-btn:hover {
            transform: scale(1.05);
            background: #1ed760;
        }

        .spotify-auth-btn svg {
            width: 20px;
            height: 20px;
        }

        .hidden {
            display: none !important;
        }

        .user-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            background: #222;
            padding: 8px 16px;
            border-radius: 50px;
            width: fit-content;
            margin-left: auto;
            margin-right: auto;
        }

        .user-preview img {
            width: 24px;
            height: 24px;
            border-radius: 50%;
        }

        .user-preview span {
            color: #1DB954;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .access-input-wrapper {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        #accessCodeInput {
            flex: 1;
            background: #222;
            border: 1px solid #333;
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.2s;
        }

        #accessCodeInput:focus {
            border-color: var(--spotify-green);
        }





        .access-error {
            color: #ff4d4d;
            font-size: 0.9rem;
            min-height: 20px;
        }
    </style>

    <script>
        // Auth Logic
        (async function checkAuth() {
            const overlay = document.getElementById('accessOverlay');
            const discordStep = document.getElementById('discordLoginStep');
            const codeStep = document.getElementById('codeEntryStep');

            const codeInput = document.getElementById('accessCodeInput');
            const nameInput = document.getElementById('accessNameInput'); // Reset
            const btn = document.getElementById('accessSubmitBtn');
            const errorMsg = document.getElementById('accessError');
            const copyBtn = document.getElementById('copyLogBtn');
            const clipConfirm = document.getElementById('clipConfirm');
            const skipBtn = document.getElementById('skipDiscordBtn');

            // 1. Get/Create Persistent Device ID
            let deviceId = localStorage.getItem('device_binding_id');
            if (!deviceId) {
                deviceId = 'dev_' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
                localStorage.setItem('device_binding_id', deviceId);
            }

            // Skip handler
            if (skipBtn) {
                skipBtn.addEventListener('click', () => {
                    discordStep.classList.add('hidden');
                    codeStep.classList.remove('hidden');
                    // Hide avatar
                    document.querySelector('.user-preview').style.display = 'none';
                });
            }

            // ... (Error Logging Logic Same as Before) ...
            let lastErrorLog = { timestamp: '', browser: navigator.userAgent, error: '', details: null };
            function showError(msg, details = null) {
                errorMsg.textContent = msg;
                copyBtn.classList.remove('hidden');
                lastErrorLog = { timestamp: new Date().toISOString(), error: msg, details };
                console.error('Captured Error:', lastErrorLog);
            }
            copyBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(JSON.stringify(lastErrorLog, null, 2));
                clipConfirm.style.opacity = '1';
                setTimeout(() => clipConfirm.style.opacity = '0', 2000);
            });

            // 1. Check Auth Status
            try {
                const res = await fetch('/api/auth/status');
                const data = await res.json();

                if (data.authenticated) {
                    // Fully Authorized
                    overlay.classList.add('hidden');
                    document.getElementById('appContent').style.display = 'block';
                    return;
                }

                // Not authorized, but maybe logged in to Discord?
                if (data.discordUser) {
                    // Show Code Entry Step
                    discordStep.classList.add('hidden');
                    codeStep.classList.remove('hidden');

                    discordUsername.textContent = data.discordUser.username;
                    if (data.discordUser.avatar) {
                        discordAvatar.src = `https://cdn.discordapp.com/avatars/${data.discordUser.id}/${data.discordUser.avatar}.png`;
                    } else {
                        // Default avatar
                        discordAvatar.src = 'https://cdn.discordapp.com/embed/avatars/0.png';
                    }
                    // Pre-fill name if empty
                    if (!nameInput.value) nameInput.value = data.discordUser.username;
                } else {
                    // Not logged in at all -> Show Discord Login Button (Default)
                    discordStep.classList.remove('hidden');
                    codeStep.classList.add('hidden');
                }

            } catch (e) {
                console.error('Auth Check Failed', e);
            }

            // 2. Login Flow (Code Submission only)
            async function attemptLogin() {
                const code = codeInput.value.trim();
                const name = nameInput.value.trim();

                if (!name) {
                    errorMsg.textContent = 'Please enter your name.';
                    nameInput.focus();
                    return;
                }
                if (!code) {
                    errorMsg.textContent = 'Please enter the code.';
                    codeInput.focus();
                    return;
                }

                btn.disabled = true;
                btn.style.opacity = '0.5';
                errorMsg.textContent = 'Linking Account...';
                copyBtn.classList.add('hidden');

                try {
                    const res = await fetch('/api/verify-access', {
                        method: 'POST',
                        credentials: 'include', // Force sending cookies
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: code,
                            name: name,
                            deviceId: deviceId // Send logic for fallback
                        })
                    });

                    let data;
                    try {
                        data = await res.json();
                    } catch (jsonErr) {
                        throw new Error('Server returned invalid JSON (Crash/500). Response Status: ' + res.status);
                    }

                    if (res.ok) {
                        // Success -> Fade out overlay
                        overlay.classList.add('hidden');
                        document.getElementById('appContent').style.display = 'block'; // Reveal App
                    } else {
                        // Error
                        showError(data.error || 'Invalid code', data.debug || data);
                        // Keep values so they can fix typose
                    }
                } catch (e) {
                    console.error(e);
                    // Network or JSON error
                    showError('Connection Error: ' + (e.message || 'Unknown'), { stack: e.stack });
                } finally {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            }

            btn.addEventListener('click', attemptLogin);

            // Allow Enter key on both inputs
            nameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') codeInput.focus();
            });
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') attemptLogin();
            });

            // Focus input specifically when overlay is visible
            if (!overlay.classList.contains('hidden')) {
                nameInput.focus();
            }
        })();
    </script>
</body>

</html>